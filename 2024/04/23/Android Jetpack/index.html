<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Android JetPack | æ•²å†™æ‹¾é—</title><meta name="author" content="ç‹‚å¥”çš„é¦’å¤´"><meta name="copyright" content="ç‹‚å¥”çš„é¦’å¤´"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Android JetPackLifecycleç®€ä»‹â€‹			Lifecycleæ˜¯Googleæ¨å‡ºçš„ä¸€ä¸ªå¯ä»¥æ„ŸçŸ¥ï¼ˆActivity&#x2F;Fragmentï¼‰ç­‰ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªç»„ä»¶ã€‚ä½¿ç”¨Lifecycleï¼Œï¼Œå¯ä»¥é¿å…åœ¨ï¼ˆActivity&#x2F;Fragmentï¼‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°é‡Œå†™è¿‡å¤šçš„é€»è¾‘ä»£ç ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘æ›´åŠ çš„è§£è€¦ã€‚ æºç 1234567891011121314151617181920">
<meta property="og:type" content="article">
<meta property="og:title" content="Android JetPack">
<meta property="og:url" content="https://zrmomo.github.io/2024/04/23/Android%20Jetpack/index.html">
<meta property="og:site_name" content="æ•²å†™æ‹¾é—">
<meta property="og:description" content="Android JetPackLifecycleç®€ä»‹â€‹			Lifecycleæ˜¯Googleæ¨å‡ºçš„ä¸€ä¸ªå¯ä»¥æ„ŸçŸ¥ï¼ˆActivity&#x2F;Fragmentï¼‰ç­‰ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªç»„ä»¶ã€‚ä½¿ç”¨Lifecycleï¼Œï¼Œå¯ä»¥é¿å…åœ¨ï¼ˆActivity&#x2F;Fragmentï¼‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°é‡Œå†™è¿‡å¤šçš„é€»è¾‘ä»£ç ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘æ›´åŠ çš„è§£è€¦ã€‚ æºç 1234567891011121314151617181920">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/zrmomo/images/main/image/avatar.png">
<meta property="article:published_time" content="2024-04-23T14:33:30.726Z">
<meta property="article:modified_time" content="2024-04-22T15:07:37.940Z">
<meta property="article:author" content="ç‹‚å¥”çš„é¦’å¤´">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zrmomo/images/main/image/avatar.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zrmomo.github.io/2024/04/23/Android%20Jetpack/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Android JetPack',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-04-22 23:07:37'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.githubusercontent.com/zrmomo/images/main/image/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">39</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> æ¸…å•</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="æ•²å†™æ‹¾é—"><img class="site-icon" src="https://raw.githubusercontent.com/zrmomo/images/main/image/avatar.png"/><span class="site-name">æ•²å†™æ‹¾é—</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> æ¸…å•</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> éŸ³ä¹</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> ç”µå½±</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Android JetPack</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2024-04-23T14:33:30.726Z" title="å‘è¡¨äº 2024-04-23 22:33:30">2024-04-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-04-22T15:07:37.940Z" title="æ›´æ–°äº 2024-04-22 23:07:37">2024-04-22</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Android JetPack"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="Android-JetPack"><a href="#Android-JetPack" class="headerlink" title="Android JetPack"></a>Android JetPack</h1><h2 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h2><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>â€‹			Lifecycleæ˜¯Googleæ¨å‡ºçš„ä¸€ä¸ªå¯ä»¥æ„ŸçŸ¥ï¼ˆActivity&#x2F;Fragmentï¼‰ç­‰ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªç»„ä»¶ã€‚ä½¿ç”¨Lifecycleï¼Œï¼Œå¯ä»¥é¿å…åœ¨ï¼ˆActivity&#x2F;Fragmentï¼‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°é‡Œå†™è¿‡å¤šçš„é€»è¾‘ä»£ç ï¼Œå¯ä»¥ä½¿æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘æ›´åŠ çš„è§£è€¦ã€‚</p>
<h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Lifecycle</span> &#123;</span><br><span class="line">    <span class="comment">//æ·»åŠ è§‚å¯Ÿè€…</span></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">addObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span>;</span><br><span class="line">    <span class="comment">//ç§»é™¤è§‚å¯Ÿè€…</span></span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">removeObserver</span><span class="params">(<span class="meta">@NonNull</span> LifecycleObserver observer)</span>;</span><br><span class="line">    <span class="comment">//è·å–å½“å‰çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> State <span class="title function_">getCurrentState</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œå¯¹åº”Activityç”Ÿå‘½å‘¨æœŸæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Event</span> &#123;</span><br><span class="line">        ON_CREATE,</span><br><span class="line">        ON_START,</span><br><span class="line">        ON_RESUME,</span><br><span class="line">        ON_PAUSE,</span><br><span class="line">        ON_STOP,</span><br><span class="line">        ON_DESTROY,</span><br><span class="line">        ON_ANY  <span class="comment">//å¯ä»¥å“åº”ä»»æ„ä¸€ä¸ªäº‹ä»¶</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ç”Ÿå‘½å‘¨æœŸçŠ¶æ€. ï¼ˆEventæ˜¯è¿›å…¥è¿™ç§çŠ¶æ€çš„äº‹ä»¶ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">State</span> &#123;</span><br><span class="line">        DESTROYED,</span><br><span class="line">        INITIALIZED,</span><br><span class="line">        CREATED,</span><br><span class="line">        STARTED,</span><br><span class="line">        RESUMED;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ¤æ–­è‡³å°‘æ˜¯æŸä¸€çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAtLeast</span><span class="params">(<span class="meta">@NonNull</span> State state)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Lifecycle ä½¿ç”¨ä¸¤ç§ä¸»è¦æšä¸¾è·Ÿè¸ªå…¶å…³è”ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼š</p>
<ol>
<li>Eventï¼Œç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶å¯¹åº”Activity&#x2F;Fragmentç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚</li>
<li>Stateï¼Œç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼Œè€ŒEventæ˜¯æŒ‡è¿›å…¥ä¸€ç§çŠ¶æ€çš„äº‹ä»¶ã€‚ Eventè§¦å‘çš„æ—¶æœºï¼š</li>
</ol>
<ul>
<li>ON_CREATEã€ON_STARTã€ON_RESUMEäº‹ä»¶ï¼Œæ˜¯åœ¨LifecycleOwnerå¯¹åº”çš„æ–¹æ³•æ‰§è¡Œ ä¹‹å åˆ†å‘ã€‚</li>
<li>ON_PAUSEã€ON_STOPã€ON_DESTROYäº‹ä»¶ï¼Œæ˜¯åœ¨LifecycleOwnerå¯¹åº”çš„æ–¹æ³•è°ƒç”¨ ä¹‹å‰ åˆ†å‘ã€‚ è¿™ä¿è¯äº†LifecycleOwneræ˜¯åœ¨è¿™ä¸ªçŠ¶æ€å†…ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/zrmomo/images/main/image/202404082309767.webp" alt="eventä¸stateå…³ç³»å›¾.png"></p>
<p><code>Event</code> ä»£è¡¨ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–é‚£ä¸ªç¬é—´ç‚¹ï¼Œè€Œ <code>State</code> åˆ™è¡¨ç¤ºç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªé˜¶æ®µã€‚</p>
<ul>
<li><code>INITIALIZED</code>ï¼šåœ¨ <code>ON_CREATE</code> äº‹ä»¶è§¦å‘å‰ã€‚</li>
<li><code>CREATED</code>ï¼šåœ¨ <code>ON_CREATE</code> äº‹ä»¶è§¦å‘åä»¥åŠ <code>ON_START</code> äº‹ä»¶è§¦å‘å‰ï¼›æˆ–è€…åœ¨ <code>ON_STOP</code> äº‹ä»¶è§¦å‘åä»¥åŠ <code>ON_DESTROY</code> äº‹ä»¶è§¦å‘å‰ã€‚</li>
<li><code>STARTED</code>ï¼šåœ¨ <code>ON_START</code> äº‹ä»¶è§¦å‘åä»¥åŠ <code>ON_RESUME</code> äº‹ä»¶è§¦å‘å‰ï¼›æˆ–è€…åœ¨ <code>ON_PAUSE</code> äº‹ä»¶è§¦å‘åä»¥åŠ <code>ON_STOP</code> äº‹ä»¶è§¦å‘å‰ã€‚</li>
<li><code>RESUMED</code>ï¼šåœ¨ <code>ON_RESUME</code> äº‹ä»¶è§¦å‘åä»¥åŠ <code>ON_PAUSE</code> äº‹ä»¶è§¦å‘å‰ã€‚</li>
<li><code>DESTROYED</code>ï¼šåœ¨ <code>ON_DESTROY</code> äº‹ä»¶è§¦å‘ä¹‹åã€‚</li>
</ul>
<h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>â€‹		AppComponentActivityå’ŒFragmentActivityéƒ½æ˜¯ç»§æ‰¿äº†ComponentActivityã€‚ComponentActivityå®ç°äº†LifecycleOwneræ¥å£ã€‚åœ¨ComponentActivityçš„onCreateç”Ÿå‘½å‘¨æœŸå›è°ƒä¸­ä¼šæ·»åŠ ä¸€ä¸ªFragmentï¼Œæ‰€ä»¥æˆ‘ä»¬å°±æ˜¯å€ŸåŠ©Fragmentæ¥å®ç°ç”Ÿå‘½å‘¨æœŸçš„è§‚å¯Ÿçš„ã€‚</p>
<h3 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h3><p><strong>1.Lifecycleæ˜¯æ€æ ·æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸçš„ï¼Ÿ</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JvmStatic</span>  <span class="comment">// è¡¨æ˜è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¯ä»¥åœ¨ Java ä»£ç ä¸­ç›´æ¥é€šè¿‡ç±»åè°ƒç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">injectIfNeededIn</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;  <span class="comment">// å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œæ¥å—ä¸€ä¸ª Activity å‚æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">29</span>) &#123;  <span class="comment">// æ£€æŸ¥è®¾å¤‡çš„ API çº§åˆ«æ˜¯å¦å¤§äºç­‰äº 29ï¼ˆAndroid 10ï¼‰</span></span><br><span class="line">        <span class="comment">// åœ¨ API 29+ï¼ˆAndroid 10+ï¼‰ä¸Šï¼Œå¯ä»¥ç›´æ¥æ³¨å†Œæ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ</span></span><br><span class="line">        LifecycleCallbacks.registerIn(activity)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯¹äº API 29 ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œä¸ºäº†ä¿æŒä¸æ—§ç‰ˆæœ¬çš„ ProcessLifecycleOwner å…¼å®¹æ€§</span></span><br><span class="line">    <span class="comment">// ï¼ˆè¿™å¯èƒ½åœ¨ lifecycle-runtime æ›´æ–°æ—¶ä¸ä¼šæ›´æ–°ï¼Œå¹¶ä¸”éœ€è¦æ”¯æŒä¸ç»§æ‰¿è‡ª support åº“ä¸­çš„ FragmentActivity çš„æ´»åŠ¨ï¼‰ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ framework fragment æ¥è·å–æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æ—¶åº</span></span><br><span class="line">    <span class="keyword">val</span> manager = activity.fragmentManager  <span class="comment">// è·å– Activity çš„ FragmentManager</span></span><br><span class="line">    <span class="keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="literal">null</span>) &#123;  <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ äº† ReportFragment</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ° ReportFragmentï¼Œåˆ™æ·»åŠ ä¸€ä¸ªæ–°çš„ ReportFragment å®ä¾‹</span></span><br><span class="line">        manager.beginTransaction().add(ReportFragment(), REPORT_FRAGMENT_TAG).commit()</span><br><span class="line">        <span class="comment">// æäº¤äº‹åŠ¡ï¼Œå¸Œæœ›æˆ‘ä»¬æ˜¯ç¬¬ä¸€ä¸ªè¿›è¡Œäº‹åŠ¡æäº¤çš„</span></span><br><span class="line">        manager.executePendingTransactions()  <span class="comment">// æ‰§è¡Œæ‰€æœ‰æŒ‚èµ·çš„äº‹åŠ¡ï¼Œç¡®ä¿ ReportFragment è¢«ç«‹å³æ·»åŠ </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		åœ¨ Android 10 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œç›´æ¥ä½¿ç”¨ <code>LifecycleCallbacks</code> æ³¨å†Œç”Ÿå‘½å‘¨æœŸå›è°ƒï¼›åœ¨ Android 10 ä»¥ä¸‹ç‰ˆæœ¬ï¼Œé€šè¿‡æ·»åŠ ä¸€ä¸ª <code>ReportFragment</code> æ¥ç›‘å¬ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿åœ¨ä¸åŒç‰ˆæœ¬çš„ Android è®¾å¤‡ä¸Šéƒ½èƒ½æ­£ç¡®åœ°ç®¡ç†å’Œè·Ÿè¸ª Activity çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p><strong>2.Lifecycleæ˜¯å¦‚ä½•å¤„ç†ç”Ÿå‘½å‘¨æœŸçš„ï¼Ÿ</strong></p>
<p>â€‹		é€šè¿‡è°ƒç”¨äº†<code>((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯LifecycleRegistry ç±»æ¥å¤„ç†è¿™äº›ç”Ÿå‘½å‘¨æœŸã€‚</p>
<p><strong>3.LifecycleObserverçš„æ–¹æ³•æ˜¯æ€ä¹ˆå›è°ƒæ˜¯çš„å‘¢ï¼Ÿ</strong></p>
<p>â€‹		LifecycleRegistry çš„ handleLifecycleEventæ–¹æ³•ï¼Œç„¶åä¼šé€šè¿‡å±‚å±‚è°ƒç”¨æœ€åé€šè¿‡åå°„åˆ°LifecycleObserveræ–¹æ³•ä¸Šçš„@OnLifecycleEvent(Lifecycle.Event.XXX)æ³¨è§£å€¼ï¼Œæ¥è°ƒç”¨å¯¹åº”çš„æ–¹æ³•</p>
<p><strong>4.ä¸ºä»€ä¹ˆLifecycleObserverå¯ä»¥æ„ŸçŸ¥åˆ°Activityçš„ç”Ÿå‘½å‘¨æœŸ</strong></p>
<p>â€‹		LifecycleRegistryè°ƒç”¨handleLifecycleEventæ–¹æ³•æ—¶ä¼šä¼ é€’Eventç±»å‹ï¼Œç„¶åä¼šé€šè¿‡å±‚å±‚è°ƒç”¨ï¼Œæœ€åæ˜¯é€šè¿‡åå°„è·å–æ³¨è§£çš„å€¼ï¼Œåˆ°LifecycleObserveræ–¹æ³•ä¸Šçš„@OnLifecycleEvent(Lifecycle.Event.XXX)æ³¨è§£ä¸Šå¯¹åº”çš„Eventçš„å€¼ï¼Œæ³¨æ„è¿™ä¸ªå€¼æ˜¯å’ŒActivity&#x2F;Fragmentçš„ç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸€å¯¹åº”çš„ï¼Œæ‰€ä»¥å°±å¯ä»¥æ„ŸçŸ¥Activityã€Fragmentçš„ç”Ÿå‘½å‘¨æœŸäº†ã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6893870636733890574?searchId=20240326213943242B524B2C94BE2B8654#heading-13">â€œç»ˆäºæ‡‚äº†â€œç³»åˆ—ï¼šJetpack AACå®Œæ•´è§£æï¼ˆä¸€ï¼‰Lifecycle å®Œå…¨æŒæ¡ï¼</a></p>
<h2 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a>ViewModel</h2><h3 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>â€‹		<a target="_blank" rel="noopener" href="https://developer.android.com/reference/androidx/lifecycle/ViewModel?hl=zh-cn"><code>ViewModel</code></a> ç±»æ˜¯ä¸€ç§<a target="_blank" rel="noopener" href="https://developer.android.com/topic/architecture/ui-layer/stateholders?hl=zh-cn">ä¸šåŠ¡é€»è¾‘æˆ–å±å¹•çº§çŠ¶æ€å®¹å™¨</a>ã€‚å®ƒç”¨äºå°†çŠ¶æ€å…¬å¼€ç»™ç•Œé¢ï¼Œä»¥åŠå°è£…ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘ã€‚ å®ƒçš„ä¸»è¦ä¼˜ç‚¹æ˜¯ï¼Œå®ƒå¯ä»¥ç¼“å­˜çŠ¶æ€ï¼Œå¹¶å¯åœ¨é…ç½®æ›´æ”¹åæŒä¹…ä¿ç•™ç›¸åº”çŠ¶æ€ã€‚è¿™æ„å‘³ç€åœ¨ activity ä¹‹é—´å¯¼èˆªæ—¶æˆ–è¿›è¡Œé…ç½®æ›´æ”¹åï¼ˆä¾‹å¦‚æ—‹è½¬å±å¹•æ—¶ï¼‰ï¼Œç•Œé¢å°†æ— éœ€é‡æ–°æå–æ•°æ®ã€‚</p>
<p>â€‹		<code>ViewModel</code> å¯ä»¥åšåˆ°åœ¨é…ç½®å˜æ›´åä¾ç„¶æŒæœ‰çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œåœ¨ç°åœ¨çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¼€å§‹å°† <strong>Viewæ•°æ®</strong> ä¸ é€»è¾‘ è—äº <code>ViewModel</code> ä¸­ï¼Œç„¶åå¯¹å¤–éƒ¨æš´æ¼è§‚å¯Ÿè€…ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸¸å¸¸ä¼šæ­é… <code>LiveData</code> ä¸€èµ·ä½¿ç”¨ï¼Œä»¥æ­¤æ›´å®¹æ˜“çš„ä¿æŒçŠ¶æ€åŒæ­¥ã€‚</p>
<p>â€‹		<code>ViewModel</code> ä¹Ÿä¸æ˜¯ä¸‡èƒ½ï¼Œå…¶åªèƒ½é¿å…é…ç½®å˜æ›´æ—¶é¿å…çŠ¶æ€ä¸¢å¤±ã€‚æ¯”å¦‚å¦‚æœæˆ‘ä»¬çš„Appæ˜¯å› ä¸º <strong>å†…å­˜ä¸è¶³</strong> è€Œè¢«ç³»ç»Ÿ<strong>kill</strong> æ‰ï¼Œæ­¤æ—¶ <code>ViewModel</code> ä¹Ÿä¼šè¢«æ¸…é™¤ ğŸ”º ã€‚</p>
<h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><ul>
<li>åŸç”Ÿæ‰‹åŠ¨åˆ›å»ºViewModel</li>
</ul>
<p>åœ¨ Activity æˆ– Fragment ä¸­è·å– ViewModel å¯¹è±¡</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> viewModel = ViewModelProvider(<span class="keyword">this</span>).<span class="keyword">get</span>(MyViewModel::<span class="keyword">class</span>.java)</span><br></pre></td></tr></table></figure>

<p>æ‰©å±•ï¼š</p>
<p><code>ViewModelStore</code>: è´Ÿè´£å­˜å‚¨ViewModel.</p>
<p><code>Factory</code>: è´Ÿè´£å®ä¾‹åŒ–å…·ä½“çš„ViewModelç±»å‹.</p>
<h3 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h3><p>â€‹		ViewModelç±»è‡ªå·±çš„ä»£ç æ²¡å¤šå°‘ï¼Œè¦çœ‹ViewModelProvideræ˜¯æ€ä¹ˆæŠŠå®ƒåˆ›å»ºå‡ºæ¥çš„ã€‚</p>
<p>â€‹		ViewModelProviderçš„æ„é€ æ–¹æ³•ä¼ å…¥äº†thisä¹Ÿå°±æ˜¯å½“å‰ä½œç”¨åŸŸ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ViewModelProvider</span><span class="params">(<span class="meta">@NonNull</span> ViewModelStoreOwner owner)</span> &#123;</span><br><span class="line">    <span class="comment">// ä» owner è·å– ViewModelStoreï¼Œç”¨äºå­˜å‚¨ ViewModel å®ä¾‹</span></span><br><span class="line">    <span class="built_in">this</span>(owner.getViewModelStore(),</span><br><span class="line">        <span class="comment">// æ£€æŸ¥ owner æ˜¯å¦å®ç°äº† HasDefaultViewModelProviderFactory æ¥å£</span></span><br><span class="line">        <span class="comment">// å¦‚æœå®ç°äº†ï¼Œåˆ™ä½¿ç”¨ owner æä¾›çš„é»˜è®¤ ViewModelProvider.Factory</span></span><br><span class="line">        <span class="comment">// å¦åˆ™ï¼Œä½¿ç”¨ NewInstanceFactory çš„å®ä¾‹</span></span><br><span class="line">        owner <span class="keyword">instanceof</span> HasDefaultViewModelProviderFactory</span><br><span class="line">            ? ((HasDefaultViewModelProviderFactory) owner).getDefaultViewModelProviderFactory()</span><br><span class="line">            : NewInstanceFactory.getInstance());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// thisçš„å®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ViewModelProvider</span><span class="params">(<span class="meta">@NonNull</span> ViewModelStore store, <span class="meta">@NonNull</span> Factory factory)</span> &#123;</span><br><span class="line">        mFactory = factory;</span><br><span class="line">        mViewModelStore = store;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="ViewModelStore"><a href="#ViewModelStore" class="headerlink" title="ViewModelStore"></a>ViewModelStore</h4><p>â€‹		<code>ViewModelStore</code> æ˜¯è´Ÿè´£ç»´æŠ¤æˆ‘ä»¬ <code>ViewModel</code> å®ä¾‹çš„å…·ä½“ç±»ï¼Œå†…éƒ¨æœ‰ä¸€ä¸ª <strong>map</strong> çš„åˆé›†ï¼Œç”¨äºä¿å­˜æˆ‘ä»¬åˆ›å»ºçš„æ‰€æœ‰ <code>ViewModel</code> ï¼Œå¹¶å¯¹å¤–æä¾›äº† <code>clear()</code> æ–¹æ³•ï¼Œä»¥ <strong>ä¾¿äºéé…ç½®å˜æ›´æ—¶æ¸…é™¤ç¼“å­˜</strong> ã€‚</p>
<p>çœ‹ä¸‹getViewModelStoreçš„å…·ä½“å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># FragmentActivity</span><br><span class="line"><span class="keyword">public</span> ViewModelStore <span class="title function_">getViewModelStore</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> FragmentActivity.<span class="built_in">this</span>.getViewModelStore();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> ViewModelStore <span class="title function_">getViewModelStore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (getApplication() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Your activity is not yet attached to the &quot;</span></span><br><span class="line">                    + <span class="string">&quot;Application instance. You can&#x27;t request ViewModel before onCreate call.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ensureViewModelStore();</span><br><span class="line">        <span class="keyword">return</span> mViewModelStore;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">ensureViewModelStore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mViewModelStore == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å– NonConfigurationInstances å¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡åŒ…å«äº†ä¸Šä¸€æ¬¡é…ç½®å˜æ›´æ—¶çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ï¼Œä¹Ÿå°±åŒ…æ‹¬ä¹‹å‰åˆ›å»ºçš„ViewModelStore,åŸç†æ˜¯ä»¥é™æ€ç±»çš„å½¢å¼å­˜å‚¨åœ¨å†…å­˜ä¸­</span></span><br><span class="line">            <span class="type">NonConfigurationInstances</span> <span class="variable">nc</span> <span class="operator">=</span></span><br><span class="line">                    (NonConfigurationInstances) getLastNonConfigurationInstance();</span><br><span class="line">            <span class="keyword">if</span> (nc != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// ä» NonConfigurationInstances æ¢å¤ ViewModelStore</span></span><br><span class="line">                mViewModelStore = nc.viewModelStore;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mViewModelStore == <span class="literal">null</span>) &#123;</span><br><span class="line">                mViewModelStore = <span class="keyword">new</span> <span class="title class_">ViewModelStore</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		è¿™ä¸ªæ–¹æ³•æ˜¯ViewModelStoreOwneræ¥å£çš„æ–¹æ³•ï¼Œæ‹¥æœ‰ViewModelStoreçš„èŒƒå›´ã€‚æ­¤æ¥å£çš„å®ç°çš„è´£ä»»æ˜¯åœ¨é…ç½®æ›´æ”¹æœŸé—´ä¿ç•™æ‹¥æœ‰çš„ ViewModelStore å¹¶åœ¨è¯¥ä½œç”¨åŸŸå°†è¦é”€æ¯æ—¶è°ƒç”¨ViewModelStore.clear() ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ViewModelStoreOwner</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns owned &#123;<span class="doctag">@link</span> ViewModelStore&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a &#123;<span class="doctag">@code</span> ViewModelStore&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    ViewModelStore <span class="title function_">getViewModelStore</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ViewModelStoreçš„æ•°æ®ç»“æ„ä¹Ÿéå¸¸ç®€å•ï¼Œé‡Œé¢æ˜¯ä¸€ä¸ªHashMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ViewModelStore</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, ViewModel&gt; mMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(String key, ViewModel viewModel)</span> &#123;</span><br><span class="line">        <span class="type">ViewModel</span> <span class="variable">oldViewModel</span> <span class="operator">=</span> mMap.put(key, viewModel);</span><br><span class="line">        <span class="keyword">if</span> (oldViewModel != <span class="literal">null</span>) &#123;</span><br><span class="line">            oldViewModel.onCleared();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ViewModel <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;String&gt; <span class="title function_">keys</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(mMap.keySet());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (ViewModel vm : mMap.values()) &#123;</span><br><span class="line">            vm.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        mMap.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¦‚æ‹¬ä¸‹ä¸Šé¢çš„é€»è¾‘ï¼š</p>
<p>â€‹		è·å–ViewModeStoreæ—¶é¦–å…ˆä¼šåˆ¤æ–­èƒ½ä¸èƒ½ä»ä¹‹å‰çš„é…ç½®ä¸­è·å¾—ï¼Œæ²¡æœ‰çš„è¯å†ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ViewModeStoreå¯¹è±¡ã€‚</p>
<h4 id="Factory"><a href="#Factory" class="headerlink" title="Factory"></a>Factory</h4><p>ç¬¬äºŒä¸ªå‚æ•°Factoryï¼Œå®ƒçš„è·å–æœ‰ä¸ªåˆ¤æ–­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">owner <span class="keyword">instanceof</span> HasDefaultViewModelProviderFactory</span><br><span class="line">            ? ((HasDefaultViewModelProviderFactory) owner).getDefaultViewModelProviderFactory()</span><br><span class="line">            : NewInstanceFactory.getInstance()</span><br></pre></td></tr></table></figure>

<p>â€‹		è¿™ä¸ªowneræ˜¯Fragmentå’ŒFragmentActivityå¯¹è±¡çš„è¯ä¸€å®šæ˜¯å®ç°äº†HasDefaultViewModelProviderFactoryè¿™ä¸ªæ¥å£çš„ã€‚çœ‹ä¸‹å®ƒä¸¤ä¸ªåœ¨getDefaultViewModelProviderFactoryè¿™ä¸ªæ–¹æ³•çš„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># ComponentActivity</span><br><span class="line"><span class="keyword">public</span> ViewModelProvider.Factory <span class="title function_">getDefaultViewModelProviderFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥ Activity æ˜¯å¦å·²ç»é™„åŠ åˆ° Application å®ä¾‹</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰ï¼ŒæŠ›å‡º IllegalStateException å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (getApplication() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Your activity is not yet attached to the &quot;</span></span><br><span class="line">                + <span class="string">&quot;Application instance. You can&#x27;t request ViewModel before onCreate call.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä¸€ä¸ªé»˜è®¤çš„ Factory å®ä¾‹</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ SavedStateViewModelFactory å®ä¾‹</span></span><br><span class="line">    <span class="keyword">if</span> (mDefaultFactory == <span class="literal">null</span>) &#123;</span><br><span class="line">        mDefaultFactory = <span class="keyword">new</span> <span class="title class_">SavedStateViewModelFactory</span>(</span><br><span class="line">                <span class="comment">// æä¾› Application å®ä¾‹</span></span><br><span class="line">                getApplication(),</span><br><span class="line">                <span class="comment">// æä¾› ViewModelStoreOwnerï¼Œé€šå¸¸æ˜¯ Activity æˆ– Fragment æœ¬èº«</span></span><br><span class="line">                <span class="built_in">this</span>,</span><br><span class="line">                <span class="comment">// æä¾› Intent ä¸­çš„é¢å¤–æ•°æ®ä½œä¸ºåˆå§‹çŠ¶æ€ï¼Œå¦‚æœ Intent ä¸º nullï¼Œåˆ™ä¼ é€’ null</span></span><br><span class="line">                getIntent() != <span class="literal">null</span> ? getIntent().getExtras() : <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›é»˜è®¤çš„ Factory å®ä¾‹</span></span><br><span class="line">    <span class="keyword">return</span> mDefaultFactory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>â€‹		å¯è§æœ€ç»ˆè¿”å›æ—¶æ˜¯ä¸€ä¸ªSavedStateViewModelFactoryå¯¹è±¡çš„å®ä¾‹ã€‚</p>
<p>ä¸‹é¢ç»§ç»­çœ‹ViewModelProviderçš„getæ–¹æ³•ï¼ŒViewModelProviderè¿™ä¸ªåå­—ä¸€çœ‹å°±çŸ¥é“æ˜¯æ¥ç”¨äºåˆ›å»ºå’Œç®¡ç† <code>ViewModel</code> å®ä¾‹çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># ViewModelProvider</span><br><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">ViewModel</span>&gt; T <span class="title function_">get</span><span class="params">(<span class="meta">@NonNull</span> Class&lt;T&gt; modelClass)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–ç±»çš„è§„èŒƒåç§°ï¼Œè¿™æ˜¯ä¸€ç§æ›´æ˜“è¯»çš„å½¢å¼ã€‚</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">canonicalName</span> <span class="operator">=</span> modelClass.getCanonicalName();</span><br><span class="line">    <span class="comment">// å¦‚æœç±»æ˜¯å±€éƒ¨çš„æˆ–åŒ¿åçš„ï¼Œå®ƒå°†æ²¡æœ‰è§„èŒƒåç§°ï¼Œæˆ‘ä»¬ä¸èƒ½å°†å…¶ç”¨ä½œViewModelã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (canonicalName == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Local and anonymous classes can not be ViewModels&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨é»˜è®¤é”®å’Œç±»çš„è§„èŒƒåç§°ä½œä¸ºé”®æ¥è·å–ViewModelå®ä¾‹ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> get(DEFAULT_KEY + <span class="string">&quot;:&quot;</span> + canonicalName, modelClass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">ViewModel</span>&gt; T <span class="title function_">get</span><span class="params">(<span class="meta">@NonNull</span> String key, <span class="meta">@NonNull</span> Class&lt;T&gt; modelClass)</span> &#123;</span><br><span class="line">    <span class="comment">// ä»ViewModelå­˜å‚¨ä¸­è·å–ä¸é”®å…³è”çš„ViewModelã€‚</span></span><br><span class="line">    <span class="type">ViewModel</span> <span class="variable">viewModel</span> <span class="operator">=</span> mViewModelStore.get(key);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœè·å–çš„ViewModelæ˜¯è¯·æ±‚çš„ç±»çš„å®ä¾‹ï¼Œåˆ™è¿”å›å®ƒã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (modelClass.isInstance(viewModel)) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå·¥å‚å®ç°äº†OnRequeryFactoryæ¥å£ï¼Œè°ƒç”¨onRequeryæ–¹æ³•ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (mFactory <span class="keyword">instanceof</span> OnRequeryFactory) &#123;</span><br><span class="line">            ((OnRequeryFactory) mFactory).onRequery(viewModel);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè·å–åˆ°çš„ViewModelä¸ä¸ºç©ºï¼Œä½†ä¸æ˜¯è¯·æ±‚çš„ç±»å‹ï¼Œåˆ™è®°å½•è­¦å‘Šã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (viewModel != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> log a warning.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå·¥å‚æ˜¯KeyedFactoryçš„å®ä¾‹ï¼Œåˆ™ä½¿ç”¨é”®å’Œç±»ç±»å‹åˆ›å»ºæ–°çš„ViewModelã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (mFactory <span class="keyword">instanceof</span> KeyedFactory) &#123;</span><br><span class="line">        viewModel = ((KeyedFactory) mFactory).create(key, modelClass);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™ï¼Œä½¿ç”¨ç±»ç±»å‹åˆ›å»ºæ–°çš„ViewModelã€‚</span></span><br><span class="line">        viewModel = mFactory.create(modelClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†æ–°åˆ›å»ºçš„ViewModelå­˜å‚¨åˆ°ViewModelå­˜å‚¨ä¸­ã€‚</span></span><br><span class="line">    mViewModelStore.put(key, viewModel);</span><br><span class="line">    <span class="comment">// è¿”å›æ–°åˆ›å»ºçš„ViewModelå®ä¾‹ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> (T) viewModel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>â€‹		é¦–å…ˆæ ¹æ®ç±»ååˆ›å»ºå”¯ä¸€çš„keyï¼Œç„¶åå…ˆä»ViewModelStoreçš„é‚£ä¸ªmapé‡Œç”¨keyå¯»æ‰¾æœ‰æ²¡æœ‰å¯¹åº”çš„å®ä¾‹ã€‚</p>
<p><strong>å¯»æ‰¾åˆ°å¯¹åº”çš„å®ä¾‹</strong></p>
<p>â€‹		å¦‚æœæœ‰çš„è¯ä¼šè°ƒç”¨mFactoryçš„onRequeryæ–¹æ³•ã€‚ä¸Šé¢è¯´äº†mFactoryæ˜¯SavedStateViewModelFactoryå¯¹è±¡çš„å®ä¾‹ã€‚é‚£ä¹ˆçœ‹å®ƒè¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># SavedStateViewModelFactory</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">onRequery</span><span class="params">(<span class="meta">@NonNull</span> ViewModel viewModel)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ ViewModel å°šæœªé™„åŠ  SavedStateHandleControllerï¼Œåˆ™é™„åŠ ä¸€ä¸ª</span></span><br><span class="line">    attachHandleIfNeeded(viewModel, mSavedStateRegistry, mLifecycle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">attachHandleIfNeeded</span><span class="params">(ViewModel viewModel, SavedStateRegistry registry,</span></span><br><span class="line"><span class="params">        Lifecycle lifecycle)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–ä¸ ViewModel å…³è”çš„ SavedStateHandleController</span></span><br><span class="line">    <span class="type">SavedStateHandleController</span> <span class="variable">controller</span> <span class="operator">=</span> viewModel.getTag(</span><br><span class="line">            TAG_SAVED_STATE_HANDLE_CONTROLLER);</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ§åˆ¶å™¨æ˜¯å¦å­˜åœ¨ä¸”å°šæœªé™„åŠ </span></span><br><span class="line">    <span class="keyword">if</span> (controller != <span class="literal">null</span> &amp;&amp; !controller.isAttached()) &#123;</span><br><span class="line">        <span class="comment">// å°†æ§åˆ¶å™¨é™„åŠ åˆ°ç”Ÿå‘½å‘¨æœŸå’Œ SavedStateRegistry</span></span><br><span class="line">        controller.attachToLifecycle(registry, lifecycle);</span><br><span class="line">        <span class="comment">// å°è¯•åœ¨ç”Ÿå‘½å‘¨æœŸä¸­æ·»åŠ  Recreator ä»¥åœ¨è¿›ç¨‹æ­»äº¡åé‡å»º ViewModel</span></span><br><span class="line">        tryToAddRecreator(registry, lifecycle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		è¿™æ®µä»£ç çš„ä¸»è¦ç›®çš„æ˜¯ç¡®ä¿ <code>ViewModel</code> å…³è”çš„ <code>SavedStateHandleController</code> è¢«æ­£ç¡®åœ°é™„åŠ åˆ°ç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€ä¿å­˜æœºåˆ¶ä¸­ï¼Œä»¥ä¾¿åœ¨è¿›ç¨‹æ­»äº¡åèƒ½å¤Ÿæ¢å¤ <code>ViewModel</code> çš„çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯å¤„ç†SavedStateHandleçš„æƒ…å†µã€‚</p>
<p>â€‹		SavedStateHandleå°±æ˜¯ä¸ºäº†å¤„ç†Appè¢«æ€æ­»åActivityé‡å»ºåï¼Œä¹Ÿèƒ½è·å–åˆ°ä¹‹å‰ä¿å­˜çš„çŠ¶æ€ã€‚æœ¬è´¨ä¹Ÿæ˜¯åŸºäº<strong>onSaveInstanceState()</strong> ä¸ <strong>onRestoreInstanceState()</strong> è¿™ä¸¤ä¸ªæ–¹æ³•ï¼ŒonSaveInstanceState()æ–¹æ³•ä¸­è°ƒç”¨<code>savedStateRegistry.performSave()</code> å»ä¿å­˜çŠ¶æ€ã€‚è¯¥æ–¹æ³•å†…éƒ¨ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ <strong>Bundle</strong> å¯¹è±¡ï¼Œç”¨äºä¿å­˜æ‰€æœ‰çŠ¶æ€,ç„¶åå†è°ƒç”¨æ‰€æœ‰ç¼“å­˜çš„çŠ¶æ€æä¾›è€…(SavedStateProvider)çš„ <code>saveState()</code> æ–¹æ³•ï¼Œä»è€Œå°†æ‰€æœ‰éœ€è¦éœ€è¦ä¿å­˜çš„çŠ¶æ€ä»¥ <strong>key-value</strong> çš„æ–¹å¼å­˜åˆ° <strong>Bundle</strong> ä¸­å»ã€‚æœ€åå†å°†è¿™ä¸ªæ•´ä½“çš„ <strong>bundle</strong> å­˜å…¥ <code>onSaveInstanceState()</code> æ–¹æ³•å‚æ•°æä¾›çš„ <strong>bundle</strong> ä¸­ã€‚ç„¶ååœ¨åˆ›å»ºViewModelæ—¶å†å–å‡ºæ¥ã€‚</p>
<p><strong>æ²¡æœ‰å¯»æ‰¾åˆ°å¯¹åº”çš„å®ä¾‹</strong></p>
<p>åˆ™è°ƒç”¨mFactoryçš„ä¹Ÿå°±æ˜¯SavedStateViewModelFactoryçš„Createæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">ViewModel</span>&gt; T <span class="title function_">create</span><span class="params">(<span class="meta">@NonNull</span> String key, <span class="meta">@NonNull</span> Class&lt;T&gt; modelClass)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸º AndroidViewModel çš„å­ç±»</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isAndroidViewModel</span> <span class="operator">=</span> AndroidViewModel.class.isAssignableFrom(modelClass);</span><br><span class="line">    Constructor&lt;T&gt; constructor;</span><br><span class="line">    <span class="comment">// æ ¹æ® ViewModel ç±»å‹é€‰æ‹©åˆé€‚çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (isAndroidViewModel) &#123;</span><br><span class="line">        constructor = findMatchingConstructor(modelClass, ANDROID_VIEWMODEL_SIGNATURE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        constructor = findMatchingConstructor(modelClass, VIEWMODEL_SIGNATURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ„é€ å‡½æ•°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„å·¥å‚æ–¹æ³•åˆ›å»º ViewModel</span></span><br><span class="line">    <span class="keyword">if</span> (constructor == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mFactory.create(modelClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º SavedStateHandleController</span></span><br><span class="line">    <span class="type">SavedStateHandleController</span> <span class="variable">controller</span> <span class="operator">=</span> SavedStateHandleController.create(</span><br><span class="line">            mSavedStateRegistry, mLifecycle, key, mDefaultArgs);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        T viewmodel;</span><br><span class="line">        <span class="comment">// æ ¹æ® ViewModel ç±»å‹ä½¿ç”¨åˆé€‚çš„æ„é€ å‡½æ•°åˆ›å»º ViewModel å®ä¾‹</span></span><br><span class="line">        <span class="keyword">if</span> (isAndroidViewModel) &#123;</span><br><span class="line">            viewmodel = constructor.newInstance(mApplication, controller.getHandle());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            viewmodel = constructor.newInstance(controller.getHandle());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä¸º ViewModel è®¾ç½® SavedStateHandleController æ ‡ç­¾</span></span><br><span class="line">        viewmodel.setTagIfAbsent(TAG_SAVED_STATE_HANDLE_CONTROLLER, controller);</span><br><span class="line">        <span class="keyword">return</span> viewmodel;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Failed to access &quot;</span> + modelClass, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;A &quot;</span> + modelClass + <span class="string">&quot; cannot be instantiated.&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;An exception happened in constructor of &quot;</span></span><br><span class="line">                + modelClass, e.getCause());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>â€‹	  åˆ¤æ–­å½“å‰æ„é€ å‡½æ•°æ˜¯ä¸æ˜¯å¸¦ <code>application</code> æˆ–è€… <code>SaveStateHandle</code> ï¼Œä»è€Œè°ƒç”¨åˆé€‚çš„ <code>newInstance()</code> æ–¹æ³•ï¼Œæœ€åå†å°†åˆ›å»ºå¥½çš„ <code>ViewModel</code> æ·»åŠ åˆ° <code>ViewModelStore</code> çš„ <strong>ç¼“å­˜</strong> ä¸­ã€‚</p>
<h3 id="ViewModelé”€æ¯"><a href="#ViewModelé”€æ¯" class="headerlink" title="ViewModelé”€æ¯"></a>ViewModelé”€æ¯</h3><p>â€‹		åœ¨åˆå§‹åŒ–Activityæ—¶ï¼Œå†…éƒ¨ä¼šä½¿ç”¨ <code>lifecycle</code> æ·»åŠ ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…ï¼Œå¹¶ç›‘å¬ <strong>onDestory()</strong> é€šçŸ¥(Acté”€æ¯)ï¼Œå¦‚æœå½“å‰é”€æ¯çš„åŸå› éé…ç½®æ›´æ”¹å¯¼è‡´ï¼Œåˆ™è°ƒç”¨ <strong>ViewModeltore.clear()</strong> ï¼Œå³æ¸…ç©ºæˆ‘ä»¬çš„ViewModelç¼“å­˜åˆ—è¡¨ï¼Œä»è€Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ <code>ViewModel</code> ä¸æ”¯æŒéé…ç½®æ›´æ”¹çš„å®ä¾‹ä¿å­˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ComponentActivity</span><span class="params">()</span> &#123;</span><br><span class="line">	getLifecycle().addObserver(<span class="keyword">new</span> <span class="title class_">LifecycleEventObserver</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source,</span></span><br><span class="line"><span class="params">                    <span class="meta">@NonNull</span> Lifecycle.Event event)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (event == Lifecycle.Event.ON_DESTROY) &#123;</span><br><span class="line">                    <span class="comment">// Clear out the available context</span></span><br><span class="line">                    mContextAwareHelper.clearAvailableContext();</span><br><span class="line">                    <span class="comment">// And clear the ViewModelStore</span></span><br><span class="line">                    <span class="keyword">if</span> (!isChangingConfigurations()) &#123;</span><br><span class="line">                        <span class="comment">// è¿™é‡Œæ¸…ç†ViewModelStore</span></span><br><span class="line">                        getViewModelStore().clear();</span><br><span class="line">                    &#125;</span><br><span class="line">                    mReportFullyDrawnExecutor.activityDestroyed();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">    fun <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (vm in map.values) &#123;</span><br><span class="line">            vm.clear()</span><br><span class="line">        &#125;</span><br><span class="line">        map.clear()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7186680109384859706?searchId=20240301103914DB08362B8704C36291BF#heading-22">https://juejin.cn/post/7186680109384859706?searchId=20240301103914DB08362B8704C36291BF#heading-22</a></p>
<h3 id="ViewModelæ€ä¹ˆå®ç°çš„é…ç½®æ›´æ”¹åæŒä¹…ä¿ç•™ç›¸åº”çŠ¶æ€"><a href="#ViewModelæ€ä¹ˆå®ç°çš„é…ç½®æ›´æ”¹åæŒä¹…ä¿ç•™ç›¸åº”çŠ¶æ€" class="headerlink" title="ViewModelæ€ä¹ˆå®ç°çš„é…ç½®æ›´æ”¹åæŒä¹…ä¿ç•™ç›¸åº”çŠ¶æ€"></a>ViewModelæ€ä¹ˆå®ç°çš„é…ç½®æ›´æ”¹åæŒä¹…ä¿ç•™ç›¸åº”çŠ¶æ€</h3><ol>
<li><strong>åˆ›å»º <code>ViewModel</code> å®ä¾‹</strong>ï¼šå½“ä½ ç¬¬ä¸€æ¬¡è¯·æ±‚ä¸€ä¸ª <code>ViewModel</code> å®ä¾‹æ—¶ï¼Œ<code>ViewModelProvider</code>ä¼šä¸ºä½ çš„ <code>Activity</code> æˆ– <code>Fragment</code> åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>ViewModel</code> å®ä¾‹ã€‚è¿™é€šå¸¸æ˜¯é€šè¿‡è°ƒç”¨ ViewModelProvider(this).get(MyViewModel::class.java)å®ç°çš„ã€‚</li>
<li>**å…³è” <code>ViewModel</code> å®ä¾‹ä¸ <code>ViewModelStore</code>**ï¼šåˆ›å»ºçš„ <code>ViewModel</code> å®ä¾‹ä¼šè¢«å­˜å‚¨åœ¨ä¸å½“å‰ <code>Activity</code> æˆ– <code>Fragment</code> ç›¸å…³è”çš„ <code>ViewModelStore</code> ä¸­ã€‚è¿™ä¸ª <code>ViewModelStore</code> æ˜¯ <code>ViewModelStoreOwner</code>ï¼ˆä¾‹å¦‚ <code>ComponentActivity</code> æˆ– <code>Fragment</code>ï¼‰æŒæœ‰çš„ï¼Œå®ƒè´Ÿè´£ç®¡ç† <code>ViewModel</code> å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
<li><strong>é…ç½®æ›´æ”¹å‘ç”Ÿ</strong>ï¼šå½“é…ç½®æ›´æ”¹ï¼ˆå¦‚å±å¹•æ—‹è½¬ï¼‰å‘ç”Ÿæ—¶ï¼Œ<code>Activity</code> ä¼šè¢«é”€æ¯å¹¶é‡æ–°åˆ›å»ºã€‚ç„¶è€Œï¼Œ<code>ViewModelStore</code> ä¸ä¼šéš <code>Activity</code> ä¸€èµ·é”€æ¯ï¼Œè€Œæ˜¯ä¼šè¢«ä¿ç•™ä¸‹æ¥ã€‚</li>
<li><strong>é‡æ–°è·å– <code>ViewModel</code> å®ä¾‹</strong>ï¼šåœ¨æ–°åˆ›å»ºçš„ <code>Activity</code> æˆ– <code>Fragment</code> ä¸­ï¼Œå½“å†æ¬¡é€šè¿‡ <code>ViewModelProviders.of(this).get(MyViewModel.class)</code> è¯·æ±‚ç›¸åŒç±»å‹çš„ <code>ViewModel</code> å®ä¾‹æ—¶ï¼Œ<code>ViewModelProviders</code> ä¼šæ£€æŸ¥å½“å‰ <code>ViewModelStore</code> ä¸­æ˜¯å¦å·²ç»å­˜åœ¨è¯¥ç±»å‹çš„ <code>ViewModel</code> å®ä¾‹ã€‚å¦‚æœå­˜åœ¨ï¼Œå®ƒä¼šè¿”å›å·²ç»å­˜åœ¨çš„å®ä¾‹ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥ç»§ç»­ä½¿ç”¨ä¹‹å‰çš„ <code>ViewModel</code> å®ä¾‹ï¼Œå…¶ä¸­ä¿å­˜çš„çŠ¶æ€ä¹Ÿä¼šå¾—åˆ°ä¿ç•™ã€‚</li>
</ol>
<p>â€‹		é€šè¿‡è¿™ç§æ–¹å¼ï¼Œ<code>ViewModel</code> èƒ½å¤Ÿåœ¨é…ç½®æ›´æ”¹åæŒä¹…ä¿ç•™ç›¸åº”çŠ¶æ€ï¼Œä»è€Œå®ç°æ•°æ®çš„æŒä¹…æ€§å’Œç®¡ç†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¨èåœ¨ <code>ViewModel</code> ä¸­å­˜å‚¨ UI ç›¸å…³çš„æ•°æ®å’Œé€»è¾‘ï¼Œè€Œä¸æ˜¯åœ¨ <code>Activity</code> æˆ– <code>Fragment</code> ä¸­ç›´æ¥å­˜å‚¨ï¼Œå› ä¸º <code>Activity</code> å’Œ <code>Fragment</code> åœ¨é…ç½®æ›´æ”¹æ—¶å¯èƒ½ä¼šè¢«é”€æ¯å’Œé‡æ–°åˆ›å»ºï¼Œè€Œ <code>ViewModel</code> å¯ä»¥è·¨è¿™äº›é…ç½®æ›´æ”¹ä¿æŒå­˜æ´»ã€‚</p>
<h3 id="ViewModelStore-ä¸ä¼šéš-Activity-ä¸€èµ·é”€æ¯ï¼Œè€Œæ˜¯ä¼šè¢«ä¿ç•™ä¸‹æ¥ã€‚æ€ä¹ˆåšåˆ°çš„ï¼Ÿ"><a href="#ViewModelStore-ä¸ä¼šéš-Activity-ä¸€èµ·é”€æ¯ï¼Œè€Œæ˜¯ä¼šè¢«ä¿ç•™ä¸‹æ¥ã€‚æ€ä¹ˆåšåˆ°çš„ï¼Ÿ" class="headerlink" title="ViewModelStore ä¸ä¼šéš Activity ä¸€èµ·é”€æ¯ï¼Œè€Œæ˜¯ä¼šè¢«ä¿ç•™ä¸‹æ¥ã€‚æ€ä¹ˆåšåˆ°çš„ï¼Ÿ"></a><code>ViewModelStore</code> ä¸ä¼šéš <code>Activity</code> ä¸€èµ·é”€æ¯ï¼Œè€Œæ˜¯ä¼šè¢«ä¿ç•™ä¸‹æ¥ã€‚æ€ä¹ˆåšåˆ°çš„ï¼Ÿ</h3><p>â€‹		å½“ <code>Activity</code> ç¬¬ä¸€æ¬¡åˆ›å»ºæ—¶ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>ViewModelStore</code>ã€‚å½“é…ç½®æ›´æ”¹å‘ç”Ÿæ—¶ï¼Œ<code>Activity</code> ä¼šé€šè¿‡ <code>onRetainNonConfigurationInstance</code> æ–¹æ³•ä¿ç•™è¿™ä¸ª <code>ViewModelStore</code>ã€‚ç„¶åï¼Œå½“ <code>Activity</code> è¢«é‡æ–°åˆ›å»ºæ—¶ï¼Œå®ƒä¼šæ£€æŸ¥æ˜¯å¦æœ‰ä¿ç•™çš„ <code>ViewModelStore</code>ï¼Œå¦‚æœæœ‰ï¼Œå®ƒä¼šä½¿ç”¨è¿™ä¸ªä¿ç•™çš„ <code>ViewModelStore</code> è€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ã€‚è¿™æ ·ï¼Œ<code>ViewModel</code> å°±å¯ä»¥åœ¨é…ç½®æ›´æ”¹åç»§ç»­å­˜åœ¨ï¼Œè€Œä¸ä¼šéš <code>Activity</code> çš„é”€æ¯è€Œé”€æ¯ã€‚</p>
<ol>
<li><strong>å¯¹äº Activity</strong>ï¼š<ul>
<li>åœ¨é…ç½®æ›´æ”¹å‘ç”Ÿæ—¶ï¼Œ<code>Activity</code> çš„ <code>onRetainNonConfigurationInstance</code> æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œ<code>Activity</code> å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥ä¿ç•™ä¸€ä¸ªå¯¹è±¡ã€‚<code>Activity</code> çš„å®ç°ä¼šå°†å…¶ <code>ViewModelStore</code> ä½œä¸ºè¿™ä¸ªä¿ç•™çš„å¯¹è±¡ã€‚</li>
<li>å½“ <code>Activity</code> è¢«é‡æ–°åˆ›å»ºæ—¶ï¼Œå®ƒä¼šé€šè¿‡ <code>getLastNonConfigurationInstance</code> æ–¹æ³•æ¥è·å–ä¹‹å‰ä¿ç•™çš„å¯¹è±¡ï¼Œä»è€Œæ¢å¤ <code>ViewModelStore</code>ã€‚</li>
</ul>
</li>
<li><strong>å¯¹äº Fragment</strong>ï¼š<ul>
<li><code>Fragment</code> çš„ä¿ç•™æœºåˆ¶ç¨æœ‰ä¸åŒã€‚<code>Fragment</code> å¯ä»¥é€šè¿‡è®¾ç½® <code>setRetainInstance(true)</code> æ¥æŒ‡ç¤ºç³»ç»Ÿåœ¨é…ç½®æ›´æ”¹æ—¶ä¿ç•™ <code>Fragment</code> å®ä¾‹ã€‚è¿™æ ·ï¼Œ<code>Fragment</code> çš„ <code>ViewModelStore</code> ä¹Ÿä¼šéšä¹‹ä¿ç•™ã€‚</li>
<li>å½“ <code>Fragment</code> è¢«é‡æ–°åˆ›å»ºæ—¶ï¼Œå®ƒä¼šé™„åŠ åˆ°æ–°çš„ <code>Activity</code> ä¸Šï¼Œä½†å…¶ <code>ViewModelStore</code> ä¼šä¿æŒä¸å˜ï¼Œä»è€Œä¿ç•™äº†å…¶ä¸­çš„ <code>ViewModel</code> å®ä¾‹ã€‚</li>
</ul>
</li>
</ol>
<h3 id="onRetainNonConfigurationInstance-å’ŒonSaveInstanceState-çš„åŒºåˆ«"><a href="#onRetainNonConfigurationInstance-å’ŒonSaveInstanceState-çš„åŒºåˆ«" class="headerlink" title="onRetainNonConfigurationInstance() å’ŒonSaveInstanceState()çš„åŒºåˆ«"></a><code>onRetainNonConfigurationInstance()</code> å’ŒonSaveInstanceState()çš„åŒºåˆ«</h3><ol>
<li>é¢—ç²’åº¦ä¸ä¸€æ ·ã€‚<strong>onSaveInstanceState()<strong>æ˜¯ä¿å­˜åˆ°Bundle</strong>ä¸­ï¼Œåªèƒ½ä¿å­˜</strong>Bundle<strong>èƒ½æ¥å—çš„æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚ä¸€äº›åŸºæœ¬ç±»å‹çš„æ•°æ®ã€‚è€Œ</strong>onRetainNonConfigurationInstance() å¯ä»¥ä¿å­˜ä»»ä½•ç±»å‹çš„æ•°æ®ï¼Œæ•°æ®ç±»å‹æ˜¯<strong>Object</strong></li>
<li><strong>onSaveInstanceState()æ•°æ®æœ€ç»ˆå­˜å‚¨åˆ°ActivityManagerService</strong>çš„ActivityRecordä¸­äº†ï¼Œä¹Ÿå°±æ˜¯å­˜åˆ°<strong>ç³»ç»Ÿè¿›ç¨‹</strong>ä¸­å»äº†ã€‚è€Œ<strong>onRetainNonConfigurationInstance()</strong> æ•°æ®æ˜¯å­˜å‚¨åˆ°<strong>ActivityClientRecord</strong>ä¸­ï¼ˆActivityClientRecordæ˜¯ä¸€ä¸ªé™æ€ç±»ï¼‰ï¼Œä¹Ÿå°±æ˜¯å­˜åˆ°<strong>åº”ç”¨æœ¬èº«çš„è¿›ç¨‹</strong>ä¸­äº†</li>
<li><strong>onSaveInstanceState</strong>å­˜åˆ°ç³»ç»Ÿè¿›ç¨‹ä¸­ï¼Œæ‰€ä»¥Appè¢«æ€ä¹‹åè¿˜æ˜¯èƒ½æ¢å¤çš„ã€‚è€Œ<strong>onRetainNonConfigurationInstance</strong>å­˜åˆ°æœ¬èº«è¿›ç¨‹ä¸­ï¼ŒAppè¢«æ€æ˜¯æ²¡æ³•æ¢å¤çš„ã€‚</li>
</ol>
<h3 id="activityè¢«é”€æ¯ViewModelæ€ä¹ˆç›‘å¬çš„ï¼Ÿ"><a href="#activityè¢«é”€æ¯ViewModelæ€ä¹ˆç›‘å¬çš„ï¼Ÿ" class="headerlink" title="activityè¢«é”€æ¯ViewModelæ€ä¹ˆç›‘å¬çš„ï¼Ÿ"></a>activityè¢«é”€æ¯ViewModelæ€ä¹ˆç›‘å¬çš„ï¼Ÿ</h3><p>â€‹		<code>ViewModel</code> å¹¶ä¸ç›´æ¥ç›‘å¬ <code>Activity</code> çš„é”€æ¯äº‹ä»¶ã€‚ç›¸åï¼Œ<code>ViewModel</code> çš„ç”Ÿå‘½å‘¨æœŸæ˜¯é€šè¿‡ <code>ViewModelStore</code> å’Œ <code>ViewModelProvider</code> æ¥ç®¡ç†çš„ã€‚å½“ <code>Activity</code> è¢«é”€æ¯æ—¶ï¼Œ<code>Activity</code> çš„ <code>ViewModelStore</code> ä¼šè¢«æ¸…ç†ï¼Œè¿™ä¼šå¯¼è‡´å­˜å‚¨åœ¨å…¶ä¸­çš„æ‰€æœ‰ <code>ViewModel</code> å®ä¾‹è¢«æ¸…é™¤ã€‚</p>
<p>â€‹		<code>ViewModel</code> ä¸ç›´æ¥ç›‘å¬ <code>Activity</code> çš„é”€æ¯ï¼Œè€Œæ˜¯é€šè¿‡ <code>ViewModelStore</code> çš„æ¸…ç†æœºåˆ¶æ¥å“åº” <code>Activity</code> ç”Ÿå‘½å‘¨æœŸçš„ç»“æŸï¼Œä»è€Œåœ¨é€‚å½“çš„æ—¶å€™æ‰§è¡Œæ¸…ç†æ“ä½œã€‚</p>
<h3 id="ViewModelStoreä»€ä¹ˆæ—¶å€™ä¼šè¢«é”€æ¯ï¼Ÿ"><a href="#ViewModelStoreä»€ä¹ˆæ—¶å€™ä¼šè¢«é”€æ¯ï¼Ÿ" class="headerlink" title="ViewModelStoreä»€ä¹ˆæ—¶å€™ä¼šè¢«é”€æ¯ï¼Ÿ"></a>ViewModelStoreä»€ä¹ˆæ—¶å€™ä¼šè¢«é”€æ¯ï¼Ÿ</h3><p><code>ViewModelStore</code> ä¼šåœ¨ä»¥ä¸‹æƒ…å†µä¸‹è¢«æ¸…ç†ï¼š</p>
<ol>
<li><strong>éé…ç½®æ›´æ”¹çš„é”€æ¯</strong>ï¼šå½“ <code>Activity</code> æˆ– <code>Fragment</code> è¢«æ°¸ä¹…é”€æ¯ï¼ˆè€Œä¸æ˜¯ç”±äºé…ç½®æ›´æ”¹ï¼Œå¦‚å±å¹•æ—‹è½¬ï¼‰æ—¶ï¼Œä¾‹å¦‚å½“ç”¨æˆ·æŒ‰ä¸‹è¿”å›é”®æˆ–è€…è°ƒç”¨äº† <code>finish()</code> æ–¹æ³•ï¼Œ<code>ViewModelStore</code> ä¼šè¢«æ¸…ç†ã€‚è¿™æ„å‘³ç€å­˜å‚¨åœ¨ <code>ViewModelStore</code> ä¸­çš„æ‰€æœ‰ <code>ViewModel</code> å®ä¾‹éƒ½ä¼šè¢«æ¸…é™¤ï¼Œå®ƒä»¬çš„ <code>onCleared()</code> æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚</li>
<li><strong>æ˜¾å¼è°ƒç”¨æ¸…ç†æ–¹æ³•</strong>ï¼šåœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡è°ƒç”¨ <code>ViewModelStore</code> çš„ <code>clear()</code> æ–¹æ³•æ¥æ˜¾å¼æ¸…ç† <code>ViewModelStore</code>ã€‚è¿™é€šå¸¸ç”¨äºç‰¹å®šçš„æ¸…ç†é€»è¾‘ï¼Œæ¯”å¦‚åœ¨å•å…ƒæµ‹è¯•ä¸­ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># ComponentActivity</span><br><span class="line"><span class="title function_">getLifecycle</span><span class="params">()</span>.addObserver(<span class="keyword">new</span> <span class="title class_">LifecycleEventObserver</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source,</span></span><br><span class="line"><span class="params">                    <span class="meta">@NonNull</span> Lifecycle.Event event)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (event == Lifecycle.Event.ON_DESTROY) &#123;</span><br><span class="line">                    <span class="comment">// Clear out the available context</span></span><br><span class="line">                    mContextAwareHelper.clearAvailableContext();</span><br><span class="line">                    <span class="comment">// And clear the ViewModelStore</span></span><br><span class="line">                    <span class="keyword">if</span> (!isChangingConfigurations()) &#123;</span><br><span class="line">                        getViewModelStore().clear();</span><br><span class="line">                    &#125;</span><br><span class="line">                    mReportFullyDrawnExecutor.activityDestroyed();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="ä¸€ä¸ªActivityæœ‰å¤šä¸ªViewModelï¼Œæ€ä¹ˆå•ç‹¬åˆ é™¤å…¶ä¸­ä¸€ä¸ª"><a href="#ä¸€ä¸ªActivityæœ‰å¤šä¸ªViewModelï¼Œæ€ä¹ˆå•ç‹¬åˆ é™¤å…¶ä¸­ä¸€ä¸ª" class="headerlink" title="ä¸€ä¸ªActivityæœ‰å¤šä¸ªViewModelï¼Œæ€ä¹ˆå•ç‹¬åˆ é™¤å…¶ä¸­ä¸€ä¸ª"></a>ä¸€ä¸ªActivityæœ‰å¤šä¸ªViewModelï¼Œæ€ä¹ˆå•ç‹¬åˆ é™¤å…¶ä¸­ä¸€ä¸ª</h3><p>é¦–å…ˆçœ‹ä¸‹ViewModelStorezæ€ä¹ˆç®¡ç†çš„ViewModelå¯¹è±¡</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="keyword">class</span> <span class="title class_">ViewModelStore</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> map = mutableMapOf&lt;String, ViewModel&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">put</span><span class="params">(key: <span class="type">String</span>, viewModel: <span class="type">ViewModel</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> oldViewModel = map.put(key, viewModel)</span><br><span class="line">        oldViewModel?.onCleared()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the `ViewModel` mapped to the given `key` or null if none exists.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">    <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="title">get</span><span class="params">(key: <span class="type">String</span>)</span></span>: ViewModel? &#123;</span><br><span class="line">        <span class="keyword">return</span> map[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@hide</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RestrictTo(RestrictTo.Scope.LIBRARY_GROUP)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">keys</span><span class="params">()</span></span>: Set&lt;String&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> HashSet(map.keys)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (vm <span class="keyword">in</span> map.values) &#123;</span><br><span class="line">            <span class="comment">// æ­¤å¤„çš„clearæ˜¯ViewModelçš„clearæ–¹æ³•</span></span><br><span class="line">            vm.clear()</span><br><span class="line">        &#125;</span><br><span class="line">        map.clear()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¦‚æœçœŸçš„è¦åˆ é™¤çš„è¯åªèƒ½ä»mapå…¥æ‰‹ï¼Œé€šè¿‡åå°„æ¥åˆ é™¤å¯¹åº”çš„ViewModelå¯¹è±¡ã€‚</p>
<p>é¦–å…ˆè·å–key</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">const</span> <span class="keyword">val</span> DEFAULT_KEY = <span class="string">&quot;androidx.lifecycle.ViewModelProvider.DefaultKey&quot;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">open</span> <span class="keyword">operator</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : ViewModel&gt;</span> <span class="title">get</span><span class="params">(modelClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T &#123;</span><br><span class="line">    	<span class="comment">// ç±»çš„å®Œå…¨é™å®šå</span></span><br><span class="line">        <span class="keyword">val</span> canonicalName = modelClass.canonicalName</span><br><span class="line">            ?: <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Local and anonymous classes can not be ViewModels&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">get</span>(<span class="string">&quot;<span class="variable">$DEFAULT_KEY</span>:<span class="variable">$canonicalName</span>&quot;</span>, modelClass)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		åœ¨ Java å’Œ Kotlin ä¸­ï¼Œ<code>canonicalName</code> æ˜¯ä¸€ä¸ªç±»çš„å®Œå…¨é™å®šåï¼ˆfully qualified nameï¼‰ï¼Œå®ƒåŒ…æ‹¬åŒ…åå’Œç±»åï¼Œä½†ä¸åŒ…æ‹¬å†…éƒ¨ç±»çš„å¤–éƒ¨ç±»åã€‚ä½¿ç”¨ <code>canonicalName</code> çš„ä¸»è¦ç›®çš„æ˜¯ç¡®ä¿è·å–çš„ç±»åæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œè¿™æ ·å¯ä»¥åœ¨ä¸åŒçš„ä¸Šä¸‹æ–‡ä¸­å‡†ç¡®åœ°å¼•ç”¨åˆ°è¿™ä¸ªç±»ã€‚</p>
<p>åå°„åˆ é™¤æºç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡åå°„è·å– ViewModelProvider çš„ DEFAULT_KEY</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getDefaultKeyViaReflection</span><span class="params">()</span></span>: String? &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨åå°„è®¿é—® ViewModelProvider ç±»ä¸­åä¸º &quot;DEFAULT_KEY&quot; çš„é™æ€å­—æ®µ</span></span><br><span class="line">        <span class="keyword">val</span> field: Field = ViewModelProvider::<span class="keyword">class</span>.java.getDeclaredField(<span class="string">&quot;DEFAULT_KEY&quot;</span>)</span><br><span class="line">        <span class="comment">// è®¾ç½®å­—æ®µä¸ºå¯è®¿é—®ï¼Œå…è®¸è¯»å–ç§æœ‰å’Œå—ä¿æŠ¤å­—æ®µ</span></span><br><span class="line">        field.isAccessible = <span class="literal">true</span></span><br><span class="line">        <span class="comment">// è·å–é™æ€å­—æ®µçš„å€¼ï¼Œè¿™é‡Œä¼ é€’ &#x27;null&#x27; å› ä¸ºé™æ€å­—æ®µä¸éœ€è¦å¯¹è±¡å®ä¾‹</span></span><br><span class="line">        field.<span class="keyword">get</span>(<span class="literal">null</span>) <span class="keyword">as</span>? String</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: NoSuchFieldException) &#123;</span><br><span class="line">        <span class="comment">// æ•è·å¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å­—æ®µï¼Œåˆ™æ‰“å°å¼‚å¸¸å¹¶è¿”å› null</span></span><br><span class="line">        e.printStackTrace()</span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: IllegalAccessException) &#123;</span><br><span class="line">        <span class="comment">// æ•è·å¼‚å¸¸ï¼Œå¦‚æœå­—æ®µä¸å¯è®¿é—®ï¼Œåˆ™æ‰“å°å¼‚å¸¸å¹¶è¿”å› null</span></span><br><span class="line">        e.printStackTrace()</span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ DEFAULT_KEY å’Œ ViewModel ç±»åæ¥æ„å»º keyï¼Œå¹¶å°è¯•ä» ViewModelStore ä¸­ç§»é™¤å¯¹åº”çš„ ViewModel å®ä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> ViewModelStore.<span class="title">removeViewModel</span><span class="params">(viewModelClass: <span class="type">Class</span>&lt;<span class="type">out</span> <span class="type">ViewModel</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡ä¹‹å‰å®šä¹‰çš„å‡½æ•°è·å– DEFAULT_KEY</span></span><br><span class="line">    <span class="keyword">val</span> defaultKey = getDefaultKeyViaReflection() ?: <span class="keyword">return</span></span><br><span class="line">    <span class="comment">// è·å– ViewModel ç±»çš„è§„èŒƒåï¼Œå¦‚æœä¸ºç©ºåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">val</span> viewModelKey = viewModelClass.canonicalName ?: <span class="keyword">throw</span> IllegalArgumentException(<span class="string">&quot;Class name is null&quot;</span>)</span><br><span class="line">    <span class="comment">// æ„å»ºç”¨äºæ ‡è¯† ViewModel å®ä¾‹çš„å®Œæ•´ key</span></span><br><span class="line">    <span class="keyword">val</span> fullKey = <span class="string">&quot;<span class="variable">$defaultKey</span>:<span class="variable">$viewModelKey</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨åå°„è®¿é—® ViewModelStore ç±»ä¸­åä¸º &quot;mMap&quot; çš„ç§æœ‰å­—æ®µ</span></span><br><span class="line">        <span class="keyword">val</span> mapField = ViewModelStore::<span class="keyword">class</span>.java.getDeclaredField(<span class="string">&quot;mMap&quot;</span>)</span><br><span class="line">        <span class="comment">// è®¾ç½®å­—æ®µä¸ºå¯è®¿é—®</span></span><br><span class="line">        mapField.isAccessible = <span class="literal">true</span></span><br><span class="line">        <span class="comment">// è·å–è¯¥å®ä¾‹çš„ mMap å±æ€§ï¼Œå®ƒæ˜¯ä¸€ä¸ªå­˜å‚¨ ViewModel çš„ HashMap</span></span><br><span class="line">        <span class="keyword">val</span> map = mapField.<span class="keyword">get</span>(<span class="keyword">this</span>) <span class="keyword">as</span>? HashMap&lt;String, ViewModel&gt;</span><br><span class="line">        <span class="comment">// å¦‚æœ HashMap å­˜åœ¨ï¼Œå°è¯•ç§»é™¤å¯¹åº” key çš„ ViewModel å®ä¾‹</span></span><br><span class="line">        map?.remove(fullKey)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: NoSuchFieldException) &#123;</span><br><span class="line">        <span class="comment">// æ•è·å¼‚å¸¸ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å­—æ®µï¼Œåˆ™æ‰“å°å¼‚å¸¸</span></span><br><span class="line">        e.printStackTrace()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: IllegalAccessException) &#123;</span><br><span class="line">        <span class="comment">// æ•è·å¼‚å¸¸ï¼Œå¦‚æœå­—æ®µä¸å¯è®¿é—®ï¼Œåˆ™æ‰“å°å¼‚å¸¸</span></span><br><span class="line">        e.printStackTrace()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>â€‹		<code>ViewModel</code> çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†å­˜å‚¨å’Œç®¡ç†ä¸ UI ç›¸å…³çš„æ•°æ®ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸæ˜¯è‡ªåŠ¨ç®¡ç†çš„ã€‚å¦‚æœä½ éœ€è¦åœ¨é€»è¾‘ä¸Šâ€œåˆ é™¤â€ä¸€ä¸ª <code>ViewModel</code>ï¼Œæœ€å¥½æ˜¯é‡æ„ä½ çš„æ•°æ®ç®¡ç†ç­–ç•¥ï¼Œä½¿å…¶ç¬¦åˆ <code>ViewModel</code> çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æ–¹å¼ã€‚</p>
<h3 id="ä½¿ç”¨ViewModelè¿›è¡Œç•Œé¢é—´çš„æ•°æ®ä¼ é€’"><a href="#ä½¿ç”¨ViewModelè¿›è¡Œç•Œé¢é—´çš„æ•°æ®ä¼ é€’" class="headerlink" title="ä½¿ç”¨ViewModelè¿›è¡Œç•Œé¢é—´çš„æ•°æ®ä¼ é€’"></a>ä½¿ç”¨ViewModelè¿›è¡Œç•Œé¢é—´çš„æ•°æ®ä¼ é€’</h3><h4 id="åŒä¸€ä¸ªActivityçš„fragment-ä¹‹é—´å…±äº«æ•°æ®"><a href="#åŒä¸€ä¸ªActivityçš„fragment-ä¹‹é—´å…±äº«æ•°æ®" class="headerlink" title="åŒä¸€ä¸ªActivityçš„fragment ä¹‹é—´å…±äº«æ•°æ®"></a>åŒä¸€ä¸ªActivityçš„fragment ä¹‹é—´å…±äº«æ•°æ®</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SharedViewModel</span> : <span class="type">ViewModel</span>() &#123;</span><br><span class="line">    <span class="keyword">val</span> sharedData = MutableLiveData&lt;String&gt;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªViewModelè¢«Activityå¼•ç”¨çš„è¯ï¼Œå®ƒçš„å¯¹è±¡å°±ä¼šè¢«ä¿å­˜åˆ°è¿™ä¸ªActivityçš„ViewModelStoreä¸­ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FragmentA</span> : <span class="type">Fragment</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModel: SharedViewModel <span class="keyword">by</span> viewModels(&#123; requireActivity() &#125;)</span><br><span class="line">    <span class="comment">// è¿™ä¸¤ç§åˆ›å»ºæ–¹å¼ç­‰ä»·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModel <span class="keyword">by</span> activityViewModels&lt;SharedViewModel&gt;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FragmentB</span> : <span class="type">Fragment</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> viewModel: SharedViewModel <span class="keyword">by</span> viewModels(&#123; requireActivity() &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Activityä¸å…¶å†…éƒ¨çš„Fragmentè¿›è¡Œæ•°æ®"><a href="#Activityä¸å…¶å†…éƒ¨çš„Fragmentè¿›è¡Œæ•°æ®" class="headerlink" title="Activityä¸å…¶å†…éƒ¨çš„Fragmentè¿›è¡Œæ•°æ®"></a>Activityä¸å…¶å†…éƒ¨çš„Fragmentè¿›è¡Œæ•°æ®</h4><p>ä¸ä¸Šé¢åŒç†</p>
<h4 id="ä¸åŒActivityçš„fragment-ä¹‹é—´å…±äº«æ•°æ®"><a href="#ä¸åŒActivityçš„fragment-ä¹‹é—´å…±äº«æ•°æ®" class="headerlink" title="ä¸åŒActivityçš„fragment ä¹‹é—´å…±äº«æ•°æ®"></a>ä¸åŒActivityçš„fragment ä¹‹é—´å…±äº«æ•°æ®</h4><ol>
<li>ä½¿ç”¨ Application çº§åˆ«çš„ ViewModelï¼š<br>ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª Application çº§åˆ«çš„ ViewModelï¼Œè¿™æ ·ä¸åŒçš„ Activity å’Œå®ƒä»¬çš„ Fragment éƒ½å¯ä»¥è®¿é—®åŒä¸€ä¸ª ViewModel å®ä¾‹ã€‚</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SharedViewModel</span>(application: Application) : AndroidViewModel(application) &#123;</span><br><span class="line">    <span class="keyword">val</span> sharedData = MutableLiveData&lt;String&gt;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyApplication</span> : <span class="type">Application</span>() &#123;</span><br><span class="line">    <span class="keyword">val</span> sharedViewModel: SharedViewModel <span class="keyword">by</span> lazy &#123;</span><br><span class="line">        ViewModelProvider(<span class="keyword">this</span>, ViewModelProvider.AndroidViewModelFactory.getInstance(<span class="keyword">this</span>))</span><br><span class="line">            .<span class="keyword">get</span>(SharedViewModel::<span class="keyword">class</span>.java)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨ Fragment ä¸­è·å– Application çº§åˆ«çš„ ViewModel</span></span><br><span class="line"><span class="keyword">val</span> sharedViewModel = (activity?.application <span class="keyword">as</span>? MyApplication)?.sharedViewModel</span><br></pre></td></tr></table></figure>

<h4 id="Activityä¹‹é—´å…±äº«æ•°æ®"><a href="#Activityä¹‹é—´å…±äº«æ•°æ®" class="headerlink" title="Activityä¹‹é—´å…±äº«æ•°æ®"></a>Activityä¹‹é—´å…±äº«æ•°æ®</h4><ol>
<li>ä¸¤ä¸ª Activity æƒ³è¦å…±äº«åŒä¸€ä¸ª ViewModelï¼Œå°±å¿…é¡»ä»ä¸€ä¸ª ViewModelStore ä¸­è·å–ã€‚</li>
<li>ViewModel è¢«ä¸¤ä¸ª Activity æŒæœ‰ï¼Œé‚£ä¹ˆä¸€ä¸ª Activity é”€æ¯æ—¶ï¼ŒViewModel å¹¶ä¸èƒ½é”€æ¯ï¼Œå¦‚æœé”€æ¯æ‰ ViewModelï¼Œé‚£ä¹ˆå¦ä¸€ä¸ª Activity å°±æ— æ³•ä½¿ç”¨ ViewModelã€‚å› æ­¤è¦è€ƒè™‘å¥½èµ„æºé‡Šæ”¾çš„é—®é¢˜ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚è§£å†³æ–¹æ¡ˆæ˜¯ï¼šå½“æŒæœ‰ ViewModel çš„æ‰€æœ‰ Activity éƒ½é”€æ¯æ—¶ï¼Œæ‰é”€æ¯è¯¥ ViewModelï¼ŒåŒæ—¶é”€æ¯åˆ›å»ºè¯¥ ViewModel çš„ ViewModelStoreã€‚</li>
<li>æ¯ä¸ªå…±äº«çš„ViewModelå¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„ViewModelStoreï¼Œç„¶åå°†è¿™ä¸ªViewModelStoreé€šè¿‡é™æ€mapå­˜å‚¨ä¸ºå…¨å±€çš„</li>
<li>å½“è¿™ä¸ªViewModelçš„ä½¿ç”¨è€…éƒ½é”€æ¯åå°±å°†å¯¹åº”çš„ViewModelStoreä¹Ÿé”€æ¯ï¼Œå¯ä»¥é€šè¿‡ç›‘å¬activityçš„lifecycleå®ç°</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼“å­˜ HashMapï¼Œkey ä¸º scopeNameï¼Œvalue ä¸º ViewModelStoreOwner</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> cache: HashMap&lt;String, ShareViewModelStoreOwner&gt; = hashMapOf()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰StoreOwnerç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShareViewModelStoreOwner</span> : <span class="type">ViewModelStoreOwner</span> &#123;</span><br><span class="line">	<span class="comment">// åˆ›å»ºä½¿ç”¨activité›†åˆ</span></span><br><span class="line">    <span class="keyword">var</span> activityList = arrayListOf&lt;ComponentActivity&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»‘å®šActivity</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bindHost</span><span class="params">(componentActivity: <span class="type">ComponentActivity</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!activityList.contains(componentActivity)) &#123;</span><br><span class="line">            activityList.add(componentActivity)</span><br><span class="line">        &#125;</span><br><span class="line">        componentActivity.lifecycle.addObserver(<span class="keyword">object</span> : LifecycleEventObserver &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStateChanged</span><span class="params">(source: <span class="type">LifecycleOwner</span>, event: <span class="type">Lifecycle</span>.<span class="type">Event</span>)</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (event == Lifecycle.Event.ON_DESTROY) &#123;</span><br><span class="line">                    activityList.remove(componentActivity)</span><br><span class="line">                    <span class="keyword">if</span> (activityList.isEmpty()) &#123;</span><br><span class="line">                        cache.entries.find &#123; it.value == <span class="keyword">this</span><span class="symbol">@ShareViewModelStoreOwner</span> &#125;?.also &#123;</span><br><span class="line">                            viewModelStore.clear()</span><br><span class="line">                            cache.remove(it.key)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> viewModelStore: ViewModelStore</span><br><span class="line">        <span class="keyword">get</span>() = ViewModelStore()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> shareViewModel: ShareViewModel =</span><br><span class="line">						ViewModelProvider(cache[<span class="string">&quot;share&quot;</span>]!!)[ShareViewModel::<span class="keyword">class</span>.java]</span><br></pre></td></tr></table></figure>

<p>â€‹			ViewModelä½¿ç”¨ViewModelProvideråˆ›å»ºï¼Œç„¶åéœ€è¦ä¼ å…¥ä¸€ä¸ª ViewModelStoreï¼Œè¿™ä¸ªViewModelStoreå°±æ˜¯å­˜å‚¨ViewModeçš„ã€‚</p>
<p>å¤šä¸ªactivityä½¿ç”¨åŒä¸€ä¸ªViewModelå°±éœ€è¦æ˜¯ä»åŒä¸€ä¸ªViewModelStoreä¸­åˆ›å»ºçš„å¯¹è±¡ã€‚</p>
<p>ä¸Šé¢å¯ä»¥å†ä¼˜åŒ–ä½¿ç”¨</p>
<h2 id="LiveData"><a href="#LiveData" class="headerlink" title="LiveData"></a>LiveData</h2><h3 id="ç®€ä»‹-2"><a href="#ç®€ä»‹-2" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>â€‹		<strong>LiveData æ˜¯å¯æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸçš„ï¼Œå¯è§‚å¯Ÿçš„ï¼Œæ•°æ®æŒæœ‰è€…</strong>ã€‚LiveData å¯ä»¥å’Œç”Ÿå‘½å‘¨æœŸç»‘å®šï¼Œå½“ Activity å’Œ Fragment å¤„äºæ´»è·ƒçŠ¶æ€æ—¶æ‰è¿›è¡Œæ•°æ®å›è°ƒï¼Œå¹¶åœ¨ Lifecycle å¤„äºé”€æ¯çŠ¶æ€ï¼ˆDESTROYEDï¼‰æ—¶è‡ªåŠ¨ç§»é™¤æ•°æ®ç›‘å¬è¡Œä¸ºï¼Œä»è€Œé¿å…äº†å¸¸è§çš„å†…å­˜æ³„éœ²å’Œ NPE é—®é¢˜</p>
<p>â€‹		<a href="https://link.juejin.cn/?target=https://developer.android.com/reference/androidx/lifecycle/LiveData"><code>LiveData</code></a> æ˜¯ä¸€ç§å¯è§‚å¯Ÿçš„æ•°æ®å­˜å‚¨å™¨ç±»ã€‚ä¸å¸¸è§„çš„å¯è§‚å¯Ÿç±»ä¸åŒï¼Œ<code>LiveData</code> å…·æœ‰ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥èƒ½åŠ›ï¼Œæ„æŒ‡å®ƒéµå¾ªå…¶ä»–åº”ç”¨ç»„ä»¶ï¼ˆå¦‚ <code>activity</code>ã€<code>fragment</code> æˆ– <code>service</code>ï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚è¿™ç§æ„ŸçŸ¥èƒ½åŠ›å¯ç¡®ä¿ <code>LiveData</code> ä»…æ›´æ–°å¤„äºæ´»è·ƒç”Ÿå‘½å‘¨æœŸçŠ¶æ€çš„åº”ç”¨ç»„ä»¶è§‚å¯Ÿè€…</p>
<h3 id="ä½¿ç”¨-1"><a href="#ä½¿ç”¨-1" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> liveData = MutableLiveData&lt;String&gt;()</span><br><span class="line">liveData.value = <span class="string">&quot;æ–°çš„å€¼&quot;</span></span><br><span class="line"></span><br><span class="line">liveData.observe(<span class="keyword">this</span>, Observer &#123; value -&gt;</span><br><span class="line">    <span class="comment">// æ›´æ–°ç•Œé¢</span></span><br><span class="line">    textView.text = value</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="æºç è§£æ-1"><a href="#æºç è§£æ-1" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h3><h4 id="æ³¨å†Œç›‘å¬"><a href="#æ³¨å†Œç›‘å¬" class="headerlink" title="æ³¨å†Œç›‘å¬"></a>æ³¨å†Œç›‘å¬</h4><p>çœ‹æ³¨å†Œç›‘å¬çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">observe</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner owner, <span class="meta">@NonNull</span> Observer&lt;? <span class="built_in">super</span> T&gt; observer)</span> &#123;</span><br><span class="line">    <span class="comment">//é™å®šåªèƒ½åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ observe æ–¹æ³•</span></span><br><span class="line">    assertMainThread(<span class="string">&quot;observe&quot;</span>);</span><br><span class="line">    <span class="comment">//å½“ Lifecycle å·²ç»å¤„äº DESTROYED çŠ¶æ€æ—¶ï¼Œæ­¤æ—¶è¿›è¡Œ observe æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ ¹æ®ä¼ å…¥å‚æ•°æ„å»ºä¸€ä¸ªæ–°çš„ä»£ç† Observer</span></span><br><span class="line">    <span class="type">LifecycleBoundObserver</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LifecycleBoundObserver</span>(owner, observer);</span><br><span class="line">    <span class="type">ObserverWrapper</span> <span class="variable">existing</span> <span class="operator">=</span> mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="literal">null</span> &amp;&amp; !existing.isAttachedTo(owner)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Cannot add the same observer&quot;</span></span><br><span class="line">                + <span class="string">&quot; with different lifecycles&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (existing != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//observer ä¹‹å‰å·²ç»å’ŒåŒä¸ª owner ä¸€èµ·ä¼ è¿›æ¥è¿‡äº†ï¼Œæ­¤å¤„ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†è§‚å¯Ÿè€…å’ŒLifecycleæŒæœ‰è€…ç»‘å®šèµ·æ¥</span></span><br><span class="line">    owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°LifecycleOwnerå’ŒObserverï¼ŒLifecycleOwnerçš„å®ç°ç±»æœ‰ComponentActivityå’ŒFragment,Observeræ˜¯ä¸€ä¸ªæ¥å£,é‡Œé¢å°±ä¸€ä¸ªæ–¹æ³•onChangedã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="keyword">interface</span> Observer<span class="type">&lt;T&gt;</span> &#123;</span></span><br><span class="line">   <span class="function"><span class="keyword">fun</span> <span class="title">onChanged</span><span class="params">(value: <span class="type">T</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		åœ¨observeæ–¹æ³•ä¸­owneræ˜¯è§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸæ‰€æœ‰è€…ï¼Œobserveræ˜¯è§‚å¯Ÿè€…å¯¹è±¡ã€‚ä¸¤è€…ä¸€èµ·è¢«å°è£…ä¸ºä¸€ä¸ªLifecycleBoundObserverå¯¹è±¡ï¼ŒLifecycleBoundObserveræ˜¯æŠ½è±¡ç±» ObserverWrapper çš„å®ç°ç±»ã€‚ObserverWrapper ç”¨äºåŒ…è£…å¤–éƒ¨ä¼ è¿›æ¥çš„ Observer å¯¹è±¡ï¼Œä¸ºå­ç±»å®šä¹‰å¥½ç‰¹å®šçš„æŠ½è±¡æ–¹æ³•å’Œå…±ç”¨é€»è¾‘ï¼Œä¸»è¦æ˜¯æä¾›äº†å…±ç”¨çš„çŠ¶æ€åˆ†å‘æ–¹æ³•ã€‚</p>
<h4 id="çŠ¶æ€å›è°ƒ"><a href="#çŠ¶æ€å›è°ƒ" class="headerlink" title="çŠ¶æ€å›è°ƒ"></a>çŠ¶æ€å›è°ƒ</h4><p>çŠ¶æ€çš„å®šä¹‰åœ¨æŠ½è±¡ç±»Lifecycleçš„ä¸€ä¸ªæšä¸¾ç±»ä¸­ï¼Œå…±äº”ç§</p>
<ul>
<li><code>DESTROYED</code>ï¼šé”€æ¯çŠ¶æ€ã€‚æ­¤çŠ¶æ€åï¼Œä¸ä¼šå†æ´¾å‘ä»»ä½•äº‹ä»¶ã€‚</li>
<li><code>INITIALIZED</code>ï¼šåˆå§‹åŒ–çŠ¶æ€ã€‚æ­¤çŠ¶æ€ä¸‹ï¼Œ<code>LifecycleOwner</code> å·²æ„é€ ä½†å°šæœªåˆ° <code>onCreate</code>æ–¹æ³•æ‰§è¡Œã€‚</li>
<li><code>CREATED</code>ï¼šåˆ›å»ºçŠ¶æ€ã€‚æ­¤çŠ¶æ€åœ¨ä¸¤ç§æƒ…å†µä¸‹è¾¾åˆ°ï¼š<code>onCreate</code> è°ƒç”¨åï¼›<code>onStop</code> è°ƒç”¨å‰ã€‚</li>
<li><code>STARTED</code>ï¼šå¯åŠ¨çŠ¶æ€ã€‚æ­¤çŠ¶æ€åœ¨ä¸¤ç§æƒ…å†µä¸‹è¾¾åˆ°ï¼š<code>onStart</code> è°ƒç”¨åï¼›<code>onPause</code> è°ƒç”¨å‰ã€‚</li>
<li><code>RESUMED</code>ï¼šæ¢å¤çŠ¶æ€ã€‚æ­¤çŠ¶æ€åœ¨ <code>onResume</code> è°ƒç”¨åè¾¾åˆ°ã€‚</li>
</ul>
<p>â€‹		LifecycleBoundObserver ä¹Ÿå®ç°äº† LifecycleEventObserver æ¥å£ï¼Œä»è€Œå¯ä»¥æ”¶åˆ° Lifecycle çš„æ¯æ¬¡ç”Ÿå‘½å‘¨æœŸäº‹ä»¶åˆ‡æ¢æ—¶çš„äº‹ä»¶å›è°ƒã€‚å…¶æ•´ä¸ªäº‹ä»¶æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<ol>
<li>Lifecycle çš„ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–ï¼Œä»è€Œå›è°ƒ onStateChanged æ–¹æ³•</li>
<li>onStateChanged æ–¹æ³•é¦–å…ˆåˆ¤æ–­ Lifecycle æ˜¯å¦å·²å¤„äº DESTROYED çŠ¶æ€ï¼Œæ˜¯çš„è¯åˆ™ç›´æ¥ç§»é™¤ Observerï¼Œæ•´ä¸ªå›è°ƒæµç¨‹ç»“æŸï¼Œå¦åˆ™ç»§ç»­ä»¥ä¸‹æµç¨‹</li>
<li>onStateChanged é€šè¿‡ activeStateChanged æ–¹æ³•æ¥åˆ¤æ–­ Lifecycle æ˜¯å¦ä»éæ´»è·ƒçŠ¶æ€åˆ‡æ¢åˆ°äº†æ´»è·ƒçŠ¶æ€ï¼Œæ˜¯çš„è¯åˆ™è°ƒç”¨ dispatchingValue æ–¹æ³•æ¥åˆ†å‘å€¼ï¼ŒdispatchingValue æ–¹æ³•ä¼šæ ¹æ® ObserverWrapper å†…éƒ¨çš„ mLastVersion æ¥åˆ¤æ–­æ˜¯å¦æœ‰æ–°å€¼éœ€è¦å‘å¤–éƒ¨ Observer è¿›è¡Œå›è°ƒï¼Œæ˜¯çš„è¯åˆ™å‘å…¶å›è°ƒæ–°å€¼ï¼Œå¦åˆ™ç»“æŸæµç¨‹ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LifecycleBoundObserver</span> <span class="keyword">extends</span> <span class="title class_">ObserverWrapper</span> <span class="keyword">implements</span> <span class="title class_">LifecycleEventObserver</span> &#123;</span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="keyword">final</span> LifecycleOwner mOwner;</span><br><span class="line"></span><br><span class="line">    LifecycleBoundObserver(<span class="meta">@NonNull</span> LifecycleOwner owner, Observer&lt;? <span class="built_in">super</span> T&gt; observer) &#123;</span><br><span class="line">        <span class="built_in">super</span>(observer);</span><br><span class="line">        mOwner = owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">shouldBeActive</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// åªæœ‰å½“ Lifecycle çš„å½“å‰çŠ¶æ€æ˜¯ STARTED æˆ–è€… RESUMED æ—¶</span></span><br><span class="line">        <span class="comment">// è€ŒSTARTED å’Œ RESUMEDå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸä¸ºonStartåˆ°onStopä¹‹å‰</span></span><br><span class="line">        <span class="comment">// æ‰è®¤ä¸º Lifecycle æ˜¯å¤„äºæ´»è·ƒçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">return</span> mOwner.getLifecycle().getCurrentState().isAtLeast(STARTED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ„ŸçŸ¥ç”Ÿå‘½å‘¨æœŸå˜åŒ–</span></span><br><span class="line">    <span class="comment">//å½“ Lifecycle çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å°±ä¼šè°ƒç”¨æ­¤æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStateChanged</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner source,</span></span><br><span class="line"><span class="params">            <span class="meta">@NonNull</span> Lifecycle.Event event)</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ Lifecycle å·²ç»å¤„äº DESTROYED çŠ¶æ€äº†,åˆ™ä¸»åŠ¨ç§»é™¤ mObserver</span></span><br><span class="line">        <span class="comment">// è¿™å°±æ˜¯ LiveData å¯ä»¥é¿å…å†…å­˜æ³„éœ²æœ€é‡è¦çš„ä¸€ä¸ªç‚¹</span></span><br><span class="line">        Lifecycle.<span class="type">State</span> <span class="variable">currentState</span> <span class="operator">=</span> mOwner.getLifecycle().getCurrentState();</span><br><span class="line">        <span class="keyword">if</span> (currentState == DESTROYED) &#123;</span><br><span class="line">                removeObserver(mObserver);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        	Lifecycle.<span class="type">State</span> <span class="variable">prevState</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        	<span class="comment">// æ­¤å¤„ä½¿ç”¨å¾ªç¯ï¼Œä¸ºäº†ä¿è¯åœ¨å¤„ç†å½“å‰çŠ¶æ€è¿‡ç¨‹ä¸­çŠ¶æ€åˆå‘ç”Ÿäº†æ”¹å˜ã€‚</span></span><br><span class="line">        	<span class="comment">// å¾ªç¯ç¡®ä¿æ•è·å¹¶å¤„ç†è¿™äº›å˜åŒ–ï¼Œç›´åˆ°æ²¡æœ‰æ›´å¤šçš„çŠ¶æ€å˜åŒ–å‘ç”Ÿã€‚ </span></span><br><span class="line">            <span class="keyword">while</span> (prevState != currentState) &#123;</span><br><span class="line">                prevState = currentState;</span><br><span class="line">                activeStateChanged(shouldBeActive());</span><br><span class="line">                currentState = mOwner.getLifecycle().getCurrentState();</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAttachedTo</span><span class="params">(LifecycleOwner owner)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mOwner == owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">detachObserver</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//ç§»é™¤ mObserver</span></span><br><span class="line">        mOwner.getLifecycle().removeObserver(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		<strong>å½“ownerçš„ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿæ”¹å˜ä¼šå›è°ƒåˆ°LifecycleBoundObserverçš„onStateChangedæ–¹æ³•</strong>,è¿™ä¸ªæ–¹æ³•é‡Œä¼šåˆ¤æ–­owneræ˜¯å¦èµ°åˆ°äº†<code>DESTROYED</code>ï¼Œèµ°åˆ°äº†ä¼šç§»é™¤è¿™ä¸ªownerçš„è§‚å¯Ÿè€…ã€‚ä¸æ˜¯<code>DESTROYED</code>çš„è¯ä¼šå¯¹çŠ¶æ€è¿›è¡Œåˆ†ç±»å¤„ç†ï¼Œå½“å‰çŠ¶æ€æ˜¯ STARTED æˆ–è€… RESUMED æ—¶è®¤ä¸º Lifecycle æ˜¯å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œå¦åˆ™æ˜¯ä¸æ´»è·ƒçŠ¶æ€ã€‚ç„¶åå°†æ´»è·ƒè¿˜æ˜¯ä¸æ´»è·ƒä¼ å…¥activeStateChangedæ–¹æ³•ã€‚		</p>
<p>â€‹		activeStateChanged æ–¹æ³•çš„å®ç°åœ¨æŠ½è±¡ç±»ObserverWrapperä¸­ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># ObserverWrapper</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">activeStateChanged</span><span class="params">(<span class="type">boolean</span> newActive)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (newActive == mActive) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mActive = newActive;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­å½“å‰ LiveData æ‰€æœ‰çš„ Observer æ˜¯å¦éƒ½å¤„äºéæ´»è·ƒçŠ¶æ€</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">wasInactive</span> <span class="operator">=</span> LiveData.<span class="built_in">this</span>.mActiveCount == <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//æ›´æ–° LiveData å½“å‰æ‰€æœ‰å¤„äºæ´»è·ƒçŠ¶æ€çš„ Observer çš„æ•°é‡</span></span><br><span class="line">        LiveData.<span class="built_in">this</span>.mActiveCount += mActive ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (wasInactive &amp;&amp; mActive) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ LiveData å¤„äºæ´»è·ƒçŠ¶æ€çš„ Observer æ•°é‡ä» 0 å˜æˆäº† 1,</span></span><br><span class="line">            <span class="comment">//åˆ™å›è°ƒ onActive æ–¹æ³•</span></span><br><span class="line">            onActive();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (LiveData.<span class="built_in">this</span>.mActiveCount == <span class="number">0</span> &amp;&amp; !mActive) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ LiveData å¤„äºæ´»è·ƒçŠ¶æ€çš„ Observer æ•°é‡ä» 1 å˜æˆäº† 0,</span></span><br><span class="line">            <span class="comment">//åˆ™å›è°ƒ onInactive æ–¹æ³•</span></span><br><span class="line">            onInactive();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mActive) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœ mObserver å˜æˆäº†æ´»è·ƒçŠ¶æ€ï¼Œåˆ™å‘å…¶å›è°ƒæ–°å€¼ï¼Œèµ°åˆ°è¿™é‡Œè¯´æ˜ä¹‹å‰ä¸€å®šæ˜¯éæ´»è·ƒçŠ¶æ€</span></span><br><span class="line">            dispatchingValue(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		ä¸Šé¢çš„onStateChangedæ–¹æ³•å’ŒactiveStateChangedæ˜¯å…³äºLifecycleOwner çš„ç”Ÿå‘½å‘¨æœŸå‘ç”Ÿå˜åŒ–åLiveDataçš„å›è°ƒå¤„ç†ï¼Œåœ¨observeè¿™ä¸ªæ–¹æ³•ä¸­å°†è§‚å¯Ÿè€…observerå’Œè§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸæ‰€æœ‰è€…ownerå°è£…äº†ä¸€ä¸ªLifecycleBoundObserverå¯¹è±¡ï¼Œåœ¨æ–¹æ³•çš„æœ€åé€šè¿‡<code>owner.getLifecycle().addObserver(wrapper)</code>å°†è¿™ä¸ªå¯¹è±¡åŠ å…¥åˆ°äº†ownerçš„è§‚å¯Ÿè€…åˆ—è¡¨ä¸­ã€‚</p>
<blockquote>
<p>çŠ¶æ€æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>é”€æ¯ï¼šDESTROYED</li>
<li>éæ´»è·ƒï¼šINITIALIZEDã€CREATED</li>
<li>æ´»è·ƒï¼šSTARTEDã€RESUMED</li>
</ul>
</blockquote>
<p>â€‹		activeStateChangedæ–¹æ³•é¦–å…ˆä¼šè¿›è¡Œåˆ¤æ–­è¯¥çŠ¶æ€æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœæ˜¯æ´»è·ƒæ€ä¼šè°ƒç”¨ dispatchingValue æ–¹æ³•æ¥åˆ†å‘å€¼ï¼ŒdispatchingValue æ–¹æ³•ä¼šæ ¹æ® ObserverWrapper å†…éƒ¨çš„ mLastVersion æ¥åˆ¤æ–­æ˜¯å¦æœ‰æ–°å€¼éœ€è¦å‘å¤–éƒ¨ Observer è¿›è¡Œå›è°ƒï¼Œæ˜¯çš„è¯åˆ™å‘å…¶å›è°ƒæ–°å€¼ï¼Œå¦åˆ™ç»“æŸæµç¨‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">dispatchingValue</span><span class="params">(<span class="meta">@Nullable</span> ObserverWrapper initiator)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDispatchingValue) &#123;</span><br><span class="line">            mDispatchInvalidated = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mDispatchingValue = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            mDispatchInvalidated = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯è§‚å¯Ÿè€…é¦–æ¬¡è®¢é˜…ä¼šèµ°åˆ°è¿™é‡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (initiator != <span class="literal">null</span>) &#123;</span><br><span class="line">                considerNotify(initiator);</span><br><span class="line">                initiator = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// LiveDataæ‰§è¡Œäº†setValueä¼šé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;? <span class="built_in">super</span> T&gt;, ObserverWrapper&gt;&gt; iterator =</span><br><span class="line">                        mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</span><br><span class="line">                    considerNotify(iterator.next().getValue());</span><br><span class="line">                    <span class="keyword">if</span> (mDispatchInvalidated) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (mDispatchInvalidated);</span><br><span class="line">        mDispatchingValue = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">considerNotify</span><span class="params">(ObserverWrapper observer)</span> &#123;</span><br><span class="line">    <span class="comment">//å¦‚æœ observer å¤„äºéæ´»è·ƒçŠ¶æ€ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (!observer.mActive) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ­¤å¤„åˆ¤æ–­ä¸»è¦æ˜¯ä¸ºäº†ç…§é¡¾ LifecycleBoundObserver</span></span><br><span class="line">    <span class="comment">//ç”±äº Lifecycle æœ‰å¯èƒ½çŠ¶æ€å€¼ State å·²ç»åˆ‡æ¢åˆ°äº†éæ´»è·ƒçŠ¶æ€ï¼Œä½† LifecycleBoundObserver è¿˜æœªæ”¶åˆ°äº‹ä»¶é€šçŸ¥</span></span><br><span class="line">    <span class="comment">//æ‰€ä»¥ä¸ºäº†é¿å…æ„å¤–æƒ…å†µï¼Œæ­¤å¤„ä¸»åŠ¨æ£€æŸ¥ observer çš„æ´»è·ƒçŠ¶æ€å¹¶åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°å…¶æ´»è·ƒçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (!observer.shouldBeActive()) &#123;</span><br><span class="line">        observer.activeStateChanged(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ ¹æ® observer æœ¬éƒ¨çš„ value ç‰ˆæœ¬å· mLastVersion æ¥å†³å®šæ˜¯å¦éœ€è¦å‘å…¶è¿›è¡Œå›è°ƒ</span></span><br><span class="line">    <span class="comment">//ä¸ºäº†é¿å…é‡å¤å‘æŸä¸ª observer å›è°ƒå€¼ï¼Œæ‰€ä»¥æ­¤å¤„éœ€è¦åˆ¤æ–­ä¸‹</span></span><br><span class="line">    <span class="keyword">if</span> (observer.mLastVersion &gt;= mVersion) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    observer.mLastVersion = mVersion;</span><br><span class="line">    observer.mObserver.onChanged((T) mData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹		è¿™ä¸ªmLastVersionæ˜¯æ¯ä¸ªè§‚å¯Ÿè€…è‡ªèº«ç»´æŠ¤çš„åœ¨ObserverWrapperå†…ï¼Œç„¶åLiveDataè‡ªèº«ä¹Ÿæœ‰ä¸€ä¸ªè®¡æ•°mVersionæ¥æ ‡å¿—çŠ¶æ€ï¼Œå¯¹æ¯”çš„mLastVersionå’ŒmVersionæ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å‘é€æ¶ˆæ¯ã€‚</p>
<p>ä»dispatchingValueå’ŒconsiderNotifyè¿™ä¸¤ä¸ªæ–¹æ³•çš„é€»è¾‘å¯ä»¥çœ‹å‡ºLiveDataçš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li><p>LiveData åªä¼šåœ¨ LifecycleOwner å¤„äºæ´»è·ƒçŠ¶æ€çš„æ—¶å€™æ‰è¿›è¡Œäº‹ä»¶åˆ†å‘ã€‚</p>
</li>
<li><p>è‡ªä¸»è§£ç»‘é€»è¾‘</p>
<blockquote>
<p>Activityèµ°åˆ°DESTORYçŠ¶æ€LiveDataä¼šé€šè¿‡mOwner.getLifecycle().removeObserver(this)è§£ç»‘ç›‘å¬</p>
</blockquote>
</li>
<li><p>LiveDataä¼šä¿è¯è®¢é˜…è€…æ€»èƒ½åœ¨å€¼å˜åŒ–çš„æ—¶å€™è§‚å¯Ÿåˆ°æœ€æ–°çš„å€¼ï¼Œå¹¶ä¸”æ¯ä¸ª<strong>åˆæ¬¡è®¢é˜…çš„è§‚å¯Ÿè€…</strong>éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡å›è°ƒæ–¹æ³•ã€‚</p>
<blockquote>
<p>è¿™ä¸ªç‰¹ç‚¹ä¼šå¯¼è‡´ä¸€ä¸ªç²˜æ€§äº‹ä»¶çš„é—®é¢˜ï¼šæ•°æ®å€’çŒ</p>
<p>ç”±äº <code>LiveData</code> ä¼šåœ¨è§‚å¯Ÿè€…æ´»è·ƒæ—¶å°†æœ€æ–°çš„æ•°æ®é€šçŸ¥ç»™è§‚å¯Ÿè€…ï¼Œåˆ™ä¼šäº§ç”Ÿã€Œ<strong>ç²˜æ€§äº‹ä»¶</strong>ã€çš„æƒ…å†µã€‚</p>
<p>å¦‚ç‚¹å‡» button å¼¹å‡ºä¸€ä¸ª Snackbarï¼Œåœ¨å±å¹•æ—‹è½¬æ—¶ï¼Œ<code>lifecycleOwner</code> é‡å»ºï¼Œæ–°çš„è§‚å¯Ÿè€…ä¼šå†æ¬¡è°ƒç”¨ <code>Livedata#observe()</code>ï¼Œå› æ­¤ Snackbar ä¼šå†æ¬¡å¼¹å‡ºã€‚</p>
</blockquote>
</li>
<li><p>LiveDataçš„åˆå¹¶ç­–ç•¥å°†æœ€æ–°ä¸€æ¡ä¹‹å‰çš„äº‹ä»¶å…¨éƒ¨ä¸¢å¼ƒã€‚</p>
<blockquote>
<p>é»˜è®¤ä¸é˜²æŠ–ï¼Œ<code>setValue()/postValue()</code> ä¼ å…¥ç›¸åŒçš„å€¼å¤šæ¬¡è°ƒç”¨ï¼Œè§‚å¯Ÿè€…çš„ <code>onChanged()</code> ä¼šè¢«å¤šæ¬¡è°ƒç”¨ã€‚</p>
</blockquote>
</li>
<li><p>åŒä¸€ä¸ªçŠ¶æ€åœ¨ä¸€ä¸ªUIåˆ·æ–°å‘¨æœŸä¹‹å†…å‘ç”Ÿä¸¤æ¬¡å˜åŠ¨ï¼ŒLiveDataåªä¼šå±•ç¤ºæœ€åä¸€ä¸ªã€‚</p>
<blockquote>
<p>å­˜åœ¨ä»…æœ‰éƒ¨åˆ† Observer æ”¶åˆ°äº†å›è°ƒï¼Œå…¶å®ƒ Observer åˆæ²¡æœ‰çš„å¯èƒ½æ€§ã€‚å½“å•çº¿ç¨‹è¿ç»­ä¼ å€¼æˆ–è€…å¤šçº¿ç¨‹åŒæ—¶ä¼ å€¼æ—¶ï¼Œå‡è®¾æ˜¯å…ˆåä¼  valueA å’Œ valueBï¼Œæœ€ç»ˆå¯èƒ½åªæœ‰éƒ¨åˆ† Observer æ¥æ”¶åˆ°äº† valueAï¼Œæ‰€æœ‰ Observer éƒ½æ¥æ”¶åˆ°äº† valueB</p>
</blockquote>
</li>
</ul>
<h4 id="å‘é€æ¶ˆæ¯"><a href="#å‘é€æ¶ˆæ¯" class="headerlink" title="å‘é€æ¶ˆæ¯"></a>å‘é€æ¶ˆæ¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">postValue</span><span class="params">(T value)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> postTask;</span><br><span class="line">        <span class="keyword">synchronized</span> (mDataLock) &#123;</span><br><span class="line">            postTask = mPendingData == NOT_SET;</span><br><span class="line">            mPendingData = value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!postTask) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ArchTaskExecutor.getInstance().postToMainThread(mPostValueRunnable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">mPostValueRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            Object newValue;</span><br><span class="line">            <span class="keyword">synchronized</span> (mDataLock) &#123;</span><br><span class="line">                newValue = mPendingData;</span><br><span class="line">                mPendingData = NOT_SET;</span><br><span class="line">            &#125;</span><br><span class="line">            setValue((T) newValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeOnMainThread</span><span class="params">(<span class="meta">@NonNull</span> Runnable runnable)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (isMainThread()) &#123;</span><br><span class="line">            runnable.run();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            postToMainThread(runnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postToMainThread</span><span class="params">(<span class="meta">@NonNull</span> Runnable runnable)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mMainHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mMainHandler == <span class="literal">null</span>) &#123;</span><br><span class="line">                    mMainHandler = createAsync(Looper.getMainLooper());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨HandleræŠ›å›äº†ä¸»çº¿ç¨‹</span></span><br><span class="line">        mMainHandler.post(runnable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// UIçº¿ç¨‹</span></span><br><span class="line"><span class="meta">@MainThread</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(T value)</span> &#123;</span><br><span class="line">        assertMainThread(<span class="string">&quot;setValue&quot;</span>);</span><br><span class="line">        mVersion++;</span><br><span class="line">        mData = value;</span><br><span class="line">        dispatchingValue(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>å‘é€æ¶ˆæ¯æœ€åè¿˜æ˜¯è°ƒç”¨dispatchingValueï¼Œè¿™éƒ¨åˆ†é€»è¾‘çœ‹ä¸Šä¸€èŠ‚ã€‚</p>
<h4 id="LiveData-æ•°æ®é‡æ”¾åŸå› åˆ†æ"><a href="#LiveData-æ•°æ®é‡æ”¾åŸå› åˆ†æ" class="headerlink" title="LiveData æ•°æ®é‡æ”¾åŸå› åˆ†æ"></a>LiveData æ•°æ®é‡æ”¾åŸå› åˆ†æ</h4><p>LiveData çš„æ•°æ®é‡æ”¾é—®é¢˜ä¹Ÿå«ä½œæ•°æ®å€’çŒã€ç²˜æ€§äº‹ä»¶ï¼Œæ ¸å¿ƒæºç åœ¨ LiveData#considerNotify(Observer) ä¸­ï¼š</p>
<ul>
<li>é¦–å…ˆï¼ŒLiveData å’Œè§‚å¯Ÿè€…å„è‡ªä¼šæŒæœ‰ä¸€ä¸ªç‰ˆæœ¬å· versionï¼Œæ¯æ¬¡ LiveData#setValue æˆ– postValue åï¼ŒLiveData æŒæœ‰çš„ç‰ˆæœ¬å·ä¼šè‡ªå¢ 1ã€‚åœ¨ LiveData#considerNotify(Observer) å°è¯•åˆ†å‘æ•°æ®æ—¶ï¼Œä¼šåˆ¤æ–­è§‚å¯Ÿè€…æŒæœ‰ç‰ˆæœ¬å·æ˜¯å¦å°äº LiveData çš„ç‰ˆæœ¬å·ï¼ˆObserver#mLastVersion &gt;&#x3D; LiveData#mVersion æ˜¯å¦æˆç«‹ï¼‰ï¼Œå¦‚æœæˆç«‹åˆ™è¯´æ˜è¿™ä¸ªè§‚å¯Ÿè€…è¿˜æ²¡æœ‰æ¶ˆè´¹æœ€æ–°çš„æ•°æ®ç‰ˆæœ¬ã€‚</li>
<li>è€Œè§‚å¯Ÿè€…çš„æŒæœ‰çš„åˆå§‹ç‰ˆæœ¬å·æ˜¯ -1ï¼Œå› æ­¤å½“æ³¨å†Œæ–°è§‚å¯Ÿè€…å¹¶ä¸”æ­£å¥½å®¿ä¸»çš„ç”Ÿå‘½å‘¨æœŸæ˜¯å¤§äºç­‰äºå¯è§çŠ¶æ€ï¼ˆSTARTEDï¼‰æ—¶ï¼Œå°±ä¼šå°è¯•åˆ†å‘æ•°æ®ï¼Œè¿™å°±æ˜¯æ•°æ®é‡æ”¾ã€‚</li>
</ul>
<p>ä¸ºä»€ä¹ˆ Google è¦æŠŠ LiveData è®¾è®¡ä¸ºç²˜æ€§å‘¢ï¼ŸLiveData é‡æ”¾é—®é¢˜éœ€è¦åŒºåˆ†åœºæ™¯æ¥çœ‹ â€”â€” çŠ¶æ€é€‚åˆé‡æ”¾ï¼Œè€Œäº‹ä»¶ä¸é€‚åˆé‡æ”¾ï¼š</p>
<ul>
<li>å½“ LiveData ä½œä¸ºä¸€ä¸ªçŠ¶æ€ä½¿ç”¨æ—¶ï¼Œåœ¨æ³¨å†Œæ–°è§‚å¯Ÿè€…æ—¶é‡æ”¾å·²æœ‰çŠ¶æ€æ˜¯åˆç†çš„ï¼›</li>
<li>å½“ LiveData ä½œä¸ºä¸€ä¸ªäº‹ä»¶ä½¿ç”¨æ—¶ï¼Œåœ¨æ³¨å†Œæ–°è§‚å¯Ÿè€…æ—¶é‡æ”¾å·²ç»åˆ†å‘è¿‡çš„äº‹ä»¶å°±æ˜¯ä¸åˆç†çš„ã€‚</li>
</ul>
<h4 id="LiveData-æ•°æ®é‡æ”¾é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ"><a href="#LiveData-æ•°æ®é‡æ”¾é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="LiveData æ•°æ®é‡æ”¾é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ"></a>LiveData æ•°æ®é‡æ”¾é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ</h4><p><strong>Event äº‹ä»¶åŒ…è£…å™¨ï¼š</strong></p>
<p>â€‹		å†…éƒ¨ä½¿ç”¨ä¸€ä¸ªæ ‡å¿—ä½æ ‡è®°äº‹ä»¶æ˜¯å¦å·²ç»è¢«æ¶ˆè´¹è¿‡ã€‚è¿™æ ·çš„è¯ï¼Œå½“è§‚å¯Ÿè€…æ”¶åˆ°é‡æ”¾çš„æ•°æ®æ—¶ï¼Œç”±äºå…¶ä¸­çš„æ ‡è®°ä½å·²ç»æ˜¾ç¤ºè¢«æ¶ˆè´¹ï¼Œå› æ­¤ä¼šæŠ›å¼ƒè¯¥äº‹ä»¶ã€‚</p>
<p>â€‹		Google å®˜æ–¹çš„æ–¹æ¡ˆSingeLiveData å°±æ˜¯åŸºäºè¿™ç§æ€è·¯ã€‚ä¸è¿‡ï¼Œè™½ç„¶è¿™ä¸ªæ–¹æ³•èƒ½å¤Ÿè§£å†³æ•°æ®å€’çŒé—®é¢˜ï¼Œä½†æ˜¯ä¼šæœ‰å‰¯ä½œç”¨ï¼šå¯¹äºå¤šä¸ªè§‚å¯Ÿè€…çš„æƒ…å†µï¼Œåªå…è®¸ç¬¬ä¸€ä¸ªè§‚å¯Ÿè€…æ¶ˆè´¹ï¼Œè€Œåç»­çš„è§‚å¯Ÿè€…æ— æ³•æ¶ˆè´¹å®ç°ï¼Œè¿™ä¸€èˆ¬æ˜¯ä¸èƒ½æ»¡è¶³éœ€æ±‚çš„ã€‚</p>
<p><strong>åå°„ä¿®æ”¹è§‚å¯Ÿè€…ç‰ˆæœ¬å·ï¼š</strong></p>
<p>â€‹		å®ç°æ–¹æ³•æ˜¯åœ¨æ³¨å†Œæ–°è§‚å¯Ÿè€…æ—¶ï¼Œé€šè¿‡åå°„çš„æ‰‹æ®µå°†è§‚å¯Ÿè€…æŒæœ‰çš„ç‰ˆæœ¬å·ï¼ˆObserver#mLastVersionï¼‰åŒæ­¥ä¸º LiveData çš„ç‰ˆæœ¬å·ã€‚ç¼ºç‚¹æ˜¯ä½¿ç”¨åå°„ï¼Œä½†ç¡®å®èƒ½å¤Ÿè§£å†³å¤šè§‚å¯Ÿè€…é—®é¢˜ã€‚</p>
<p>æ€è·¯ï¼šæœ¬è´¨ä¸ŠLiveDataè§‚å¯Ÿè€…åº”è¯¥æ¥æ”¶çš„æœ€æ–°çš„æ•°æ®ï¼Œè€Œä¸åº”è¯¥æ¥æ”¶æ—§çš„æ•°æ®ã€‚æ ¹æ®ä¸Šé¢&lt;LiveData æ•°æ®é‡æ”¾åŸå› åˆ†æ&gt;å¯çŸ¥ï¼Œé€šè¿‡ä¿®æ”¹è§‚å¯Ÿè€…ç‰ˆæœ¬å·ä¸ºLiveDataçš„ç‰ˆæœ¬å·æ¥é¿å…åˆæ¬¡è®¢é˜…çš„å›è°ƒã€‚</p>
<p><strong>ä½¿ç”¨ShareFlowï¼š</strong></p>
<p>å°†å¯é‡æ”¾å‚æ•°è®¾ç½®ä¸º0ã€‚</p>
<h4 id="ä½¿ç”¨ä¼˜åŠ¿"><a href="#ä½¿ç”¨ä¼˜åŠ¿" class="headerlink" title="ä½¿ç”¨ä¼˜åŠ¿"></a>ä½¿ç”¨ä¼˜åŠ¿</h4><p>LiveDataè¢«æ¨èä½¿ç”¨çš„ä¼˜åŠ¿ ï¼š</p>
<ol>
<li><strong>æ•°æ®ç¬¦åˆé¡µé¢çŠ¶æ€</strong>ï¼šLiveData éµå¾ªè§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿æ•°æ®çŠ¶æ€ä¸é¡µé¢çŠ¶æ€ç›¸ç¬¦ã€‚</li>
<li><strong>ä¸ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²</strong>ï¼šObservers æ˜¯ç»‘å®šåˆ° Lifecycle å¯¹è±¡ä¸Šçš„ï¼Œå½“Lifecycle è¢«é”€æ¯æ—¶æ‰€æœ‰ä¸ä¹‹å…³è”çš„è§‚å¯Ÿè€…éƒ½ä¼šè‡ªåŠ¨è¢«æ¸…ç†ã€‚</li>
<li><strong>é˜²æ­¢å›  Activity åœæ­¢è€Œå¯¼è‡´å´©æºƒ</strong>ï¼šåœ¨è§‚å¯Ÿè€…éæ´»è·ƒçŠ¶æ€ä¸‹ä¸ä¼šæ¶ˆè´¹äº‹ä»¶ã€‚å½“ Observer æ‰€ç»‘å®šçš„ Lifecycle å¤„äºéæ´»è·ƒçŠ¶æ€æ—¶ï¼Œæ¯”å¦‚å¤„äºè¿”å›æ ˆä¸­çš„ Activityï¼Œå®ƒå°†ä¸ä¼šæ”¶åˆ°ä»»ä½• LiveData äº‹ä»¶ã€‚</li>
<li><strong>ç®€åŒ–ç”Ÿå‘½å‘¨æœŸå¤„ç†</strong>ï¼šè‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†ã€‚UI ç»„ä»¶åªéœ€è¦å¯¹ç›¸å…³çš„æ•°æ®è¿›è¡Œç›‘å¬ï¼Œä¸éœ€è¦å…³å¿ƒæ˜¯å¦åº”è¯¥æš‚åœæˆ–è€…æ¢å¤ç›‘å¬ã€‚LiveData å…·æœ‰ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥èƒ½åŠ›ï¼Œå®ƒä¼šè‡ªåŠ¨å¯¹è¿™äº›è¿›è¡Œç®¡ç†ã€‚</li>
<li><strong>æ•°æ®å§‹ç»ˆä¿æŒæœ€æ–°çŠ¶æ€</strong>ï¼šLiveData ä»…æŒæœ‰å•ä¸ªä¸”æœ€æ–°çš„æ•°æ®ã€‚å¦‚æœä¸€ä¸ª Lifecycle å¤„äºéæ´»è·ƒçŠ¶æ€ï¼Œé‚£å½“å®ƒç”±éæ´»è·ƒçŠ¶æ€å˜ä¸ºæ´»è·ƒçŠ¶æ€çš„æ—¶å€™ï¼Œå®ƒå°†æ”¶åˆ°æœ€æ–°çš„æ•°æ®ã€‚æ¯”å¦‚ä¸€ä¸ª Activity ç”±åå°è½¬ä¸ºå‰å°ï¼Œè¿™æ—¶å€™å®ƒå°†ç«‹å³æ”¶åˆ°æœ€æ–°çš„æ•°æ®</li>
<li><strong>èµ„æºå…±äº«</strong>ï¼šå¯ç”¨äºä¸åŒç»„ä»¶é—´çš„æ•°æ®å…±äº«ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å•ä¾‹æ¨¡å¼æ¥æ‰©å±• LiveDataï¼Œè¿™æ ·å°±èƒ½è¾¾åˆ°æ•°æ®å˜åŒ–çš„æ—¶å€™ï¼Œé€šçŸ¥æ‰€æœ‰çš„è§‚å¯Ÿè€…ã€‚</li>
<li>æä¾›ã€Œå¯è¯»å¯å†™ã€å’Œã€Œä»…å¯è¯»ã€ä¸¤ä¸ªç‰ˆæœ¬æ”¶ç¼©æƒé™</li>
</ol>
<h4 id="LiveData-å­˜åœ¨çš„å±€é™"><a href="#LiveData-å­˜åœ¨çš„å±€é™" class="headerlink" title="LiveData å­˜åœ¨çš„å±€é™"></a>LiveData å­˜åœ¨çš„å±€é™</h4><ol>
<li><strong>LiveData æ•°æ®é‡æ”¾é—®é¢˜ï¼š</strong> æ³¨å†Œæ–°çš„è®¢é˜…è€…ï¼Œä¼šé‡æ–°æ”¶åˆ° LiveData å­˜å‚¨çš„æ•°æ®ï¼Œè¿™åœ¨æœ‰äº›æƒ…å†µä¸‹ä¸ç¬¦åˆé¢„æœŸ</li>
<li><strong>LiveData ä¸é˜²æŠ–é—®é¢˜ï¼š</strong> é‡å¤ setValue ç›¸åŒçš„å€¼ï¼Œè®¢é˜…è€…ä¼šæ”¶åˆ°å¤šæ¬¡ <code>onChanged()</code> å›è°ƒ</li>
<li><strong>LiveData åªèƒ½åœ¨ä¸»çº¿ç¨‹æ›´æ–°æ•°æ®ï¼š</strong> åªèƒ½åœ¨ä¸»çº¿ç¨‹ setValueï¼Œå³ä½¿ postValue å†…éƒ¨ä¹Ÿæ˜¯åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œï¼›</li>
<li><strong>LiveData ä¸¢å¤±æ•°æ®é—®é¢˜ï¼š</strong> åœ¨æ•°æ®ç”Ÿäº§é€Ÿåº¦ &gt; æ•°æ®æ¶ˆè´¹é€Ÿåº¦æ—¶ï¼ŒLiveData æ— æ³•è§‚å¯Ÿè€…èƒ½å¤Ÿæ¥æ”¶åˆ°å…¨éƒ¨æ•°æ®ã€‚æ¯”å¦‚åœ¨å­çº¿ç¨‹å¤§é‡ <code>postValue</code> æ•°æ®ä½†ä¸»çº¿ç¨‹æ¶ˆè´¹è·Ÿä¸ä¸Šæ—¶ï¼Œä¸­é—´å°±ä¼šæœ‰ä¸€éƒ¨åˆ†æ•°æ®è¢«å¿½ç•¥ã€‚</li>
</ol>
<h4 id="LiveDataBus"><a href="#LiveDataBus" class="headerlink" title="LiveDataBus"></a>LiveDataBus</h4><p>ç”¨LiveDataBusæ›¿ä»£EventBuså’ŒRxBusï¼Œå®ç°å…¨å±€é€šä¿¡ï¼Œä½¿ç”¨LiveDataçš„ç†ç”±ï¼š</p>
<ul>
<li><strong>LiveDataå…·æœ‰çš„è¿™ç§å¯è§‚å¯Ÿæ€§å’Œç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥çš„èƒ½åŠ›ï¼Œä½¿å…¶éå¸¸é€‚åˆä½œä¸ºAndroidé€šä¿¡æ€»çº¿çš„åŸºç¡€æ„ä»¶ã€‚</strong></li>
<li><strong>ä½¿ç”¨è€…ä¸ç”¨æ˜¾ç¤ºè°ƒç”¨åæ³¨å†Œæ–¹æ³•ã€‚</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LiveDataBus</span> &#123;</span><br><span class="line">	<span class="comment">// ä½¿ç”¨å“ˆå¸Œè¡¨ä¿å­˜äº‹ä»¶ååˆ° LiveData çš„æ˜ å°„å…³ç³»</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MutableLiveData&lt;Object&gt;&gt; bus;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LiveDataBus</span><span class="params">()</span> &#123;</span><br><span class="line">        bus = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SingletonHolder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">LiveDataBus</span> <span class="variable">DATA_BUS</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LiveDataBus</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LiveDataBus <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.DATA_BUS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; MutableLiveData&lt;T&gt; <span class="title function_">getChannel</span><span class="params">(String target, Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!bus.containsKey(target)) &#123;</span><br><span class="line">            bus.put(target, <span class="keyword">new</span> <span class="title class_">MutableLiveData</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (MutableLiveData&lt;T&gt;) bus.get(target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MutableLiveData&lt;Object&gt; <span class="title function_">getChannel</span><span class="params">(String target)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getChannel(target, Object.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨å†Œè®¢é˜…ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LiveDataBus.get().getChannel(<span class="string">&quot;key_test&quot;</span>, Boolean.class)</span><br><span class="line">        .observe(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">Observer</span>&lt;Boolean&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onChanged</span><span class="params">(<span class="meta">@Nullable</span> Boolean aBoolean)</span> &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>

<p>å‘é€æ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LiveDataBus.get().getChannel(<span class="string">&quot;key_test&quot;</span>).setValue(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>è§£å†³æ•°æ®å€’çŒé—®é¢˜ï¼š</p>
<p>ä½¿ç”¨åå°„hookè§‚å¯Ÿè€…çš„version</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/pengxurui/p/16490951.html">LiveData è¿˜æœ‰å­¦ä¹ çš„å¿…è¦å—ï¼Ÿâ€”â€” Jetpack ç³»åˆ—ï¼ˆ2ï¼‰</a></p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2018/07/26/android-livedatabus.html">Androidæ¶ˆæ¯æ€»çº¿çš„æ¼”è¿›ä¹‹è·¯ï¼šç”¨LiveDataBusæ›¿ä»£RxBusã€EventBus</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7173494700081414181?searchId=20240311223609A4D4BE3FD45BCBFD2D76#heading-9">ç”±æµ…å…¥æ·±ï¼Œè¯¦è§£ LiveData çš„é‚£äº›äº‹</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7049147565815627789?searchId=20240311223609A4D4BE3FD45BCBFD2D76">Jetpack MVVM ä¸ƒå®—ç½ªä¹‹äº”: åœ¨ Repository ä¸­ä½¿ç”¨ LiveData</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7007602776502960165?searchId=20240311223609A4D4BE3FD45BCBFD2D76#heading-2">ä¸åšè·Ÿé£å…šï¼ŒLiveDataï¼ŒStateFlowï¼ŒSharedFlow ä½¿ç”¨åœºæ™¯å¯¹æ¯”</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6847902222345633806?searchId=20240311223609A4D4BE3FD45BCBFD2D76#heading-3">ä»æºç çœ‹ Jetpackï¼ˆ3ï¼‰- LiveData æºç è¯¦è§£</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6903143273737814029?searchId=20240311223609A4D4BE3FD45BCBFD2D76#heading-14">â€œç»ˆäºæ‡‚äº†â€œç³»åˆ—ï¼šJetpack AACå®Œæ•´è§£æï¼ˆäºŒï¼‰LiveData å®Œå…¨æŒæ¡ï¼</a></p>
<p>LiveDataBuså®Œæ•´ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">LiveDataBus</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜ LiveData å¯¹è±¡çš„å®¹å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, BusMutableLiveData&lt;Object&gt;&gt; bus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§æœ‰æ„é€ å‡½æ•°ï¼Œç¡®ä¿å•ä¾‹æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">LiveDataBus</span><span class="params">()</span> &#123;</span><br><span class="line">        bus = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é™æ€å†…éƒ¨ç±»å®ç°å•ä¾‹æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SingletonHolder</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">LiveDataBus</span> <span class="variable">DEFAULT_BUS</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LiveDataBus</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å– LiveDataBus å®ä¾‹çš„é™æ€æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> LiveDataBus <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.DEFAULT_BUS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®š key çš„ LiveData å®ä¾‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ LiveData</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; MutableLiveData&lt;T&gt; <span class="title function_">with</span><span class="params">(String key, Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!bus.containsKey(key)) &#123;</span><br><span class="line">            bus.put(key, <span class="keyword">new</span> <span class="title class_">BusMutableLiveData</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (MutableLiveData&lt;T&gt;) bus.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–æŒ‡å®š key çš„ LiveData å®ä¾‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ LiveDataï¼Œé»˜è®¤ä¸º Object ç±»å‹</span></span><br><span class="line">    <span class="keyword">public</span> MutableLiveData&lt;Object&gt; <span class="title function_">with</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> with(key, Object.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Observer åŒ…è£…ç±»ï¼Œç”¨äº hook observeForever æ–¹æ³•ï¼Œé¿å…å†…å­˜æ³„æ¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ObserverWrapper</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Observer</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Observer&lt;T&gt; observer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ObserverWrapper</span><span class="params">(Observer&lt;T&gt; observer)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.observer = observer;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onChanged</span><span class="params">(<span class="meta">@Nullable</span> T t)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (observer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isCallOnObserve()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                observer.onChanged(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦æ˜¯ä» observeForever æ–¹æ³•è°ƒç”¨çš„ï¼Œå¦‚æœæ˜¯åˆ™è¿”å› true</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isCallOnObserve</span><span class="params">()</span> &#123;</span><br><span class="line">            StackTraceElement[] stackTrace = Thread.currentThread().getStackTrace();</span><br><span class="line">            <span class="keyword">if</span> (stackTrace != <span class="literal">null</span> &amp;&amp; stackTrace.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (StackTraceElement element : stackTrace) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;android.arch.lifecycle.LiveData&quot;</span>.equals(element.getClassName()) &amp;&amp;</span><br><span class="line">                            <span class="string">&quot;observeForever&quot;</span>.equals(element.getMethodName())) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰çš„ MutableLiveData ç±»ï¼Œç”¨äº hook observeForever æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BusMutableLiveData</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">MutableLiveData</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§‚å¯Ÿè€…çš„æ˜ å°„è¡¨ï¼Œç”¨äºä¿å­˜ ObserverWrapper å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">private</span> Map&lt;Observer, Observer&gt; observerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">observe</span><span class="params">(<span class="meta">@NonNull</span> LifecycleOwner owner, <span class="meta">@NonNull</span> Observer&lt;T&gt; observer)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.observe(owner, observer);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hook(observer);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">observeForever</span><span class="params">(<span class="meta">@NonNull</span> Observer&lt;T&gt; observer)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!observerMap.containsKey(observer)) &#123;</span><br><span class="line">                observerMap.put(observer, <span class="keyword">new</span> <span class="title class_">ObserverWrapper</span>(observer));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">super</span>.observeForever(observerMap.get(observer));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeObserver</span><span class="params">(<span class="meta">@NonNull</span> Observer&lt;T&gt; observer)</span> &#123;</span><br><span class="line">            <span class="type">Observer</span> <span class="variable">realObserver</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (observerMap.containsKey(observer)) &#123;</span><br><span class="line">                realObserver = observerMap.remove(observer);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                realObserver = observer;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">super</span>.removeObserver(realObserver);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// é€šè¿‡åå°„ä¿®æ”¹ ObserverWrapper çš„ mLastVersion å­—æ®µï¼Œé¿å…å†…å­˜æ³„æ¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">(<span class="meta">@NonNull</span> Observer&lt;T&gt; observer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// è·å– LiveData çš„ Class å¯¹è±¡</span></span><br><span class="line">    Class&lt;LiveData&gt; classLiveData = LiveData.class;</span><br><span class="line">    <span class="comment">// è·å– LiveData çš„ mObservers å­—æ®µ</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">fieldObservers</span> <span class="operator">=</span> classLiveData.getDeclaredField(<span class="string">&quot;mObservers&quot;</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½® mObservers å­—æ®µå¯è®¿é—®</span></span><br><span class="line">    fieldObservers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// è·å– mObservers å­—æ®µçš„å€¼ï¼Œå³ Observer å¯¹è±¡çš„æ˜ å°„è¡¨</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">objectObservers</span> <span class="operator">=</span> fieldObservers.get(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// è·å– mObservers å¯¹è±¡çš„ Class å¯¹è±¡</span></span><br><span class="line">    Class&lt;?&gt; classObservers = objectObservers.getClass();</span><br><span class="line">    <span class="comment">// è·å– mObservers å¯¹è±¡çš„ get æ–¹æ³•ï¼Œç”¨äºè·å– ObserverWrapper å¯¹è±¡</span></span><br><span class="line">    <span class="type">Method</span> <span class="variable">methodGet</span> <span class="operator">=</span> classObservers.getDeclaredMethod(<span class="string">&quot;get&quot;</span>, Object.class);</span><br><span class="line">    <span class="comment">// è®¾ç½® get æ–¹æ³•å¯è®¿é—®</span></span><br><span class="line">    methodGet.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// è°ƒç”¨ get æ–¹æ³•è·å–æŒ‡å®š Observer å¯¹è±¡å¯¹åº”çš„ ObserverWrapper å¯¹è±¡</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">objectWrapperEntry</span> <span class="operator">=</span> methodGet.invoke(objectObservers, observer);</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– objectWrapper å˜é‡</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">objectWrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœ objectWrapperEntry æ˜¯ Map.Entry å¯¹è±¡ï¼Œåˆ™è·å–å…¶å€¼ä½œä¸º ObserverWrapper å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (objectWrapperEntry <span class="keyword">instanceof</span> Map.Entry) &#123;</span><br><span class="line">        objectWrapper = ((Map.Entry) objectWrapperEntry).getValue();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœ objectWrapper ä¸º nullï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (objectWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;Wrapper can not be bull!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å– ObserverWrapper çš„çˆ¶ç±»ï¼Œå³ LiveData$LifecycleBoundObserver ç±»</span></span><br><span class="line">    Class&lt;?&gt; classObserverWrapper = objectWrapper.getClass().getSuperclass();</span><br><span class="line">    <span class="comment">// è·å– ObserverWrapper çš„ mLastVersion å­—æ®µ</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">fieldLastVersion</span> <span class="operator">=</span> classObserverWrapper.getDeclaredField(<span class="string">&quot;mLastVersion&quot;</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½® mLastVersion å­—æ®µå¯è®¿é—®</span></span><br><span class="line">    fieldLastVersion.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// è·å– LiveData çš„ mVersion å­—æ®µ</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">fieldVersion</span> <span class="operator">=</span> classLiveData.getDeclaredField(<span class="string">&quot;mVersion&quot;</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½® mVersion å­—æ®µå¯è®¿é—®</span></span><br><span class="line">    fieldVersion.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// è·å– LiveData çš„ç‰ˆæœ¬å·</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">objectVersion</span> <span class="operator">=</span> fieldVersion.get(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// ä¿®æ”¹ ObserverWrapper çš„ mLastVersion å­—æ®µä¸º LiveData çš„ mVersion å­—æ®µçš„å€¼</span></span><br><span class="line">    fieldLastVersion.set(objectWrapper, objectVersion);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="AppStartup"><a href="#AppStartup" class="headerlink" title="AppStartup"></a>AppStartup</h2><h3 id="ä¸‰æ–¹åº“åˆå§‹åŒ–"><a href="#ä¸‰æ–¹åº“åˆå§‹åŒ–" class="headerlink" title="ä¸‰æ–¹åº“åˆå§‹åŒ–"></a>ä¸‰æ–¹åº“åˆå§‹åŒ–</h3><p>ä¸€èˆ¬æ˜¯åœ¨Applicationçš„onCreateæ–¹æ³•ä¸­è°ƒç”¨ä¸‰æ–¹åº“çš„åˆå§‹åŒ–æ–¹æ³•ä¼ å…¥å½“å‰çš„contextã€‚</p>
<h3 id="ContentProvider-çš„å¯åŠ¨è¿‡ç¨‹"><a href="#ContentProvider-çš„å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="ContentProvider çš„å¯åŠ¨è¿‡ç¨‹"></a>ContentProvider çš„å¯åŠ¨è¿‡ç¨‹</h3><p>â€‹		<strong>ContentProvider é€šå¸¸çš„ç”¨æ³•æ˜¯ä¸ºå½“å‰è¿›ç¨‹ &#x2F; è¿œç¨‹è¿›ç¨‹æä¾›å†…å®¹æœåŠ¡ï¼Œå®ƒä»¬ä¼šåœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–</strong>ï¼Œæ­£å› å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ ContentProvider æ¥è·å¾— Context ã€‚</p>
<p>â€‹		ContentProvider#onCreate() æ˜¯æ—©äº Application#onCreate() æ‰§è¡Œçš„ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> application = context!!.applicationContext <span class="keyword">as</span> Application</span><br><span class="line">    Log.e(<span class="string">&quot;ContextProvider&quot;</span>,<span class="string">&quot;åˆå§‹åŒ– <span class="variable">$context</span> -- <span class="subst">$&#123;application&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å¦‚æœæ¯ä¸ªç¬¬ä¸‰æ–¹åº“éƒ½è‡ªå·±åˆ›å»ºäº†ä¸€ä¸ªContentProviderï¼Œé‚£ä¹ˆæœ€ç»ˆæˆ‘ä»¬Appçš„å¯åŠ¨é€Ÿåº¦å°±ä¼šå—åˆ°æ¯”è¾ƒå¤§çš„å½±å“ã€‚</strong></p>
<h3 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h3><p>å°†æ‰€æœ‰ç”¨äºåˆå§‹åŒ–çš„ContentProvideråˆå¹¶æˆä¸€ä¸ªï¼Œä»è€Œä½¿Appçš„å¯åŠ¨é€Ÿåº¦å˜å¾—æ›´å¿«ã€‚åœ¨ç»„ä»¶åŒ–ä¸­ç”¨äºåˆå§‹åŒ–ç»„ä»¶çš„application</p>
<h3 id="ä½¿ç”¨-2"><a href="#ä½¿ç”¨-2" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><ol>
<li><p>å¼•å…¥App Startupçš„åº“ã€‚</p>
</li>
<li><p>è‡ªå®šä¹‰ä¸€ä¸ªç”¨äºåˆå§‹åŒ–çš„Initializerã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LitePalInitializer</span> : <span class="type">Initializer</span>&lt;<span class="type">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">create</span><span class="params">(context: <span class="type">Context</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// è·å–applicationæ‰§è¡Œ ä¸‰æ–¹åº“çš„åˆå§‹åŒ–é€»è¾‘</span></span><br><span class="line">        LitePal.initialize(context)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">dependencies</span><span class="params">()</span></span>: List&lt;Class&lt;<span class="keyword">out</span> Initializer&lt;*&gt;&gt;&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> emptyList()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>å°†è‡ªå®šä¹‰Initializeré…ç½®åˆ°AndroidManifest.xmlå½“ä¸­ã€‚å®šä¹‰çš„é¡ºåºå°±æ˜¯åˆå§‹åŒ–çš„é¡ºåº</p>
</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">&quot;androidx.startup.InitializationProvider&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:authorities</span>=<span class="string">&quot;$&#123;applicationId&#125;.androidx-startup&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:node</span>=<span class="string">&quot;merge&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;com.example.LitePalInitializer&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:value</span>=<span class="string">&quot;androidx.startup&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitializationProvider</span> <span class="keyword">extends</span> <span class="title class_">ContentProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> getContext();</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">applicationContext</span> <span class="operator">=</span> context.getApplicationContext();</span><br><span class="line">            <span class="keyword">if</span> (applicationContext != <span class="literal">null</span>) &#123;</span><br><span class="line">                AppInitializer.getInstance(context).discoverAndInitialize();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                StartupLogger.w(<span class="string">&quot;Deferring initialization because `applicationContext` is null.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">StartupException</span>(<span class="string">&quot;Context cannot be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼“å­˜æ¯ä¸ªç»„ä»¶çš„åˆå§‹åŒ–ç»“æœ</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; mInitialized = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// åˆå§‹åŒ–æ­¤ç»„ä»¶</span></span><br><span class="line">   <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">doInitialize</span><span class="params">(Class&lt;? extends Initializer&lt;?&gt;&gt; component, Set&lt;Class&lt;?&gt;&gt; initializing)</span></span><br><span class="line">           <span class="keyword">throws</span> IllegalAccessException, InvocationTargetException, InstantiationException, NoSuchMethodException &#123;</span><br><span class="line">       <span class="keyword">synchronized</span> (sLock) &#123; <span class="comment">// 1ã€å¯¹ sLock åŠ é”</span></span><br><span class="line">           Object result;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 2ã€åˆ¤æ–­ initializing ä¸­å­˜åœ¨å½“å‰ç»„ä»¶ï¼Œè¯´æ˜å­˜åœ¨å¾ªç¯ä¾èµ–</span></span><br><span class="line">           <span class="keyword">if</span> (initializing.contains(component)) &#123;</span><br><span class="line">               <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> String.format(<span class="string">&quot;Cannot initialize %s. Cycle detected.&quot;</span>, component.getName());</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(message);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 3ã€æ£€æŸ¥å½“å‰ç»„ä»¶æ˜¯å¦å·²åˆå§‹åŒ–</span></span><br><span class="line">           <span class="keyword">if</span> (!mInitialized.containsKey(component)) &#123;</span><br><span class="line">               <span class="comment">// å½“å‰ç»„ä»¶æœªåˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">// 3.1.1 è®°å½•æ­£åœ¨åˆå§‹åŒ–</span></span><br><span class="line">               initializing.add(component);</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 3.1.2 é€šè¿‡åå°„å®ä¾‹åŒ– Initializer æ¥å£å®ç°ç±»</span></span><br><span class="line">               <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> component.getDeclaredConstructor().newInstance();</span><br><span class="line">               Initializer&lt;?&gt; initializer = (Initializer&lt;?&gt;) instance;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 3.1.3 éå†æ‰€ä¾èµ–çš„ç»„ä»¶</span></span><br><span class="line">               List&lt;Class&lt;? <span class="keyword">extends</span> <span class="title class_">Initializer</span>&lt;?&gt;&gt;&gt; dependencies = initializer.dependencies();</span><br><span class="line">               <span class="keyword">if</span> (!dependencies.isEmpty()) &#123;</span><br><span class="line">                   <span class="keyword">for</span> (Class&lt;? <span class="keyword">extends</span> <span class="title class_">Initializer</span>&lt;?&gt;&gt; clazz : dependencies) &#123;</span><br><span class="line">                       <span class="comment">// å¦‚æœæ‰€ä¾èµ–çš„ç»„ä»¶æœªåˆå§‹åŒ–ï¼Œé€’å½’æ‰§è¡Œåˆå§‹åŒ–</span></span><br><span class="line">                       <span class="keyword">if</span> (!mInitialized.containsKey(clazz)) &#123;</span><br><span class="line">                           doInitialize(clazz, initializing); <span class="comment">// æ³¨æ„ï¼šè¿™é‡Œå°† initializing ä½œä¸ºå‚æ•°ä¼ å…¥</span></span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 3.1.4 ï¼ˆåˆ°è¿™é‡Œï¼Œæ‰€ä¾èµ–çš„ç»„ä»¶å·²ç»åˆå§‹åŒ–å®Œæˆï¼‰åˆå§‹åŒ–å½“å‰ç»„ä»¶</span></span><br><span class="line">               result = initializer.create(); <span class="comment">// å‡è®¾createæ–¹æ³•ä¸éœ€è¦å‚æ•°</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">// 3.1.5 ç§»é™¤æ­£åœ¨åˆå§‹åŒ–è®°å½•</span></span><br><span class="line">               initializing.remove(component);</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 3.1.6 ç¼“å­˜åˆå§‹åŒ–ç»“æœ</span></span><br><span class="line">               mInitialized.put(component, result);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// å½“å‰ç»„ä»¶å·²ç»åˆå§‹åŒ–ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">               result = mInitialized.get(component);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> (T) result;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡åå°„å®ä¾‹åŒ– Initializer æ¥å£å®ç°ç±»ï¼Œéå†æ‰€ä¾èµ–çš„ç»„ä»¶ï¼Œå¦‚æœæ‰€ä¾èµ–çš„ç»„ä»¶æœªåˆå§‹åŒ–ï¼Œé€’å½’æ‰§è¡Œåˆå§‹åŒ–ã€‚</p>
<h2 id="Room"><a href="#Room" class="headerlink" title="Room"></a>Room</h2><h3 id="ä½¿ç”¨-3"><a href="#ä½¿ç”¨-3" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><ol>
<li>ä¾èµ–</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">implementation(libs.androidx.room.runtime)</span><br><span class="line">implementation(libs.androidx.room.ktx)</span><br><span class="line">kapt(libs.androidx.room.compiler)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>åˆ›å»ºå®ä½“ç±»</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity(tableName = <span class="string">&quot;user_entity&quot;</span>)</span></span><br><span class="line"><span class="keyword">data</span> <span class="keyword">class</span> <span class="title class_">UserEntity</span>(</span><br><span class="line">    <span class="keyword">val</span> name: String,</span><br><span class="line">    <span class="meta">@PrimaryKey</span></span><br><span class="line">    <span class="keyword">val</span> id: <span class="built_in">Int</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºDao</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸»é”®å†²çªä¹‹åçš„ç­–ç•¥ï¼Œè¿™é‡Œé€‰æ‹©ç›´æ¥è¦†ç›–åŸæ•°æ®</span></span><br><span class="line">    <span class="meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">insertUser</span><span class="params">(userEntity: <span class="type">UserEntity</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ é™¤æŸæ¡æ•°æ®</span></span><br><span class="line">    <span class="meta">@Delete</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">deleteUser</span><span class="params">(userEntity: <span class="type">UserEntity</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°æŸæ¡æ•°æ®</span></span><br><span class="line">    <span class="meta">@Update</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">updateUser</span><span class="params">(userEntity: <span class="type">UserEntity</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®idæŸ¥æ‰¾æ•°æ®</span></span><br><span class="line">    <span class="meta">@Query(<span class="string">&quot;select * from user_entity where id=:id&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">findUser</span><span class="params">(id: <span class="type">Int</span>)</span></span>: List&lt;UserEntity&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºDataBase</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(entities = [UserEntity::class], version = 1, exportSchema = false)</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">RoomDb</span> : <span class="type">RoomDatabase</span>() &#123;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">getUserDao</span><span class="params">()</span></span>: UserDao</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@Volatile</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> sInstance: RoomDb? = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> DATA_BASE_NAME = <span class="string">&quot;User.db&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">getInstance</span><span class="params">(context: <span class="type">Context</span>)</span></span>: RoomDb? &#123;</span><br><span class="line">            <span class="keyword">if</span> (sInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">                synchronized(RoomDb::<span class="keyword">class</span>.java) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (sInstance == <span class="literal">null</span>) &#123;</span><br><span class="line">                        sInstance = createInstance(context)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sInstance</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">createInstance</span><span class="params">(context: <span class="type">Context</span>)</span></span>: RoomDb? &#123;</span><br><span class="line">            <span class="keyword">return</span> Room.databaseBuilder(</span><br><span class="line">                context.applicationContext, RoomDb::<span class="keyword">class</span>.java, DATA_BASE_NAME</span><br><span class="line">            ).build()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>ä½¿ç”¨</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RoomViewModel</span>(<span class="keyword">val</span> application: Application) : AndroidViewModel(application) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">testRoom</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> db = RoomDb.getInstance(application)</span><br><span class="line">        db?.getUserDao()?.findUser(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h3 id="ä¼˜åŠ¿"><a href="#ä¼˜åŠ¿" class="headerlink" title="ä¼˜åŠ¿"></a>ä¼˜åŠ¿</h3><ul>
<li><strong>æ•°æ®åº“æŠ½è±¡å±‚</strong>ï¼šRoomæ˜¯åœ¨SQLiteä¹‹ä¸Šçš„ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œå®ƒæä¾›äº†æ›´ç®€æ´çš„æ•°æ®åº“è®¿é—®æœºåˆ¶ï¼Œå¹¶å‡å°‘äº†æ ·æ¿ä»£ç çš„ç¼–å†™ã€‚</li>
<li><strong>ç¼–è¯‘æ—¶SQLæ£€æŸ¥</strong>ï¼šRoomåœ¨ç¼–è¯‘æ—¶ä¼šæ£€æŸ¥ä½ çš„SQLæŸ¥è¯¢è¯­å¥ï¼Œè¿™æœ‰åŠ©äºåœ¨æ—©æœŸå‘ç°æ½œåœ¨çš„é—®é¢˜å’Œé”™è¯¯ã€‚</li>
<li><strong>LiveDataå’Œåç¨‹æ”¯æŒ</strong>ï¼šRoomå¤©ç„¶æ”¯æŒLiveDataå’ŒKotlinåç¨‹ï¼Œflowï¼Œè¿™ä½¿å¾—åœ¨Androidåº”ç”¨ä¸­å®ç°å“åº”å¼ç¼–ç¨‹å’Œå¼‚æ­¥æ“ä½œå˜å¾—æ›´åŠ ç®€å•å’Œç›´æ¥ã€‚</li>
<li><strong>æ˜“ç”¨æ€§å’Œå‡å°‘é”™è¯¯</strong>ï¼šé€šè¿‡ä½¿ç”¨æ³¨è§£å’ŒDAOï¼ˆæ•°æ®è®¿é—®å¯¹è±¡ï¼‰æ¨¡å¼ï¼ŒRoomä½¿å¾—æ•°æ®åº“çš„æ“ä½œæ›´åŠ ç®€æ´æ˜äº†ï¼ŒåŒæ—¶å‡å°‘äº†å› æ‰‹åŠ¨ç¼–å†™SQLè€Œå¼•å…¥çš„é”™è¯¯ã€‚</li>
<li><strong>ç®€å•çš„æ•°æ®åº“å‡çº§å’Œè¿ç§»ï¼š</strong>Room æä¾›äº†ä¸€ä¸ªç›´è§‚çš„æ–¹å¼æ¥å¤„ç†æ•°æ®åº“ç‰ˆæœ¬å‡çº§å’Œè¿ç§»ï¼Œé€šè¿‡å®šä¹‰æ•°æ®åº“ç‰ˆæœ¬å’Œè¿ç§»è·¯å¾„ï¼Œå¯ä»¥è½»æ¾ç®¡ç†æ•°æ®åº“ç»“æ„çš„å˜åŒ–ã€‚</li>
</ul>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/zrmomo/images/main/image/avatar.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/23/Android%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8/" title="Androidæœ¬åœ°å­˜å‚¨"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Androidæœ¬åœ°å­˜å‚¨</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/23/Android%20Handler%E6%9C%BA%E5%88%B6/" title="Android Handleræ¶ˆæ¯æœºåˆ¶"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">Android Handleræ¶ˆæ¯æœºåˆ¶</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://raw.githubusercontent.com/zrmomo/images/main/image/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ç‹‚å¥”çš„é¦’å¤´</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">39</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:imcoddo@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Android-JetPack"><span class="toc-number">1.</span> <span class="toc-text">Android JetPack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Lifecycle"><span class="toc-number">1.1.</span> <span class="toc-text">Lifecycle</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">1.1.2.</span> <span class="toc-text">æºç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.3.</span> <span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.4.</span> <span class="toc-text">é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ViewModel"><span class="toc-number">1.2.</span> <span class="toc-text">ViewModel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.3.</span> <span class="toc-text">æºç è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ViewModelStore"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">ViewModelStore</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Factory"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">Factory</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ViewModel%E9%94%80%E6%AF%81"><span class="toc-number">1.2.4.</span> <span class="toc-text">ViewModelé”€æ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ViewModel%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%E9%85%8D%E7%BD%AE%E6%9B%B4%E6%94%B9%E5%90%8E%E6%8C%81%E4%B9%85%E4%BF%9D%E7%95%99%E7%9B%B8%E5%BA%94%E7%8A%B6%E6%80%81"><span class="toc-number">1.2.5.</span> <span class="toc-text">ViewModelæ€ä¹ˆå®ç°çš„é…ç½®æ›´æ”¹åæŒä¹…ä¿ç•™ç›¸åº”çŠ¶æ€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ViewModelStore-%E4%B8%8D%E4%BC%9A%E9%9A%8F-Activity-%E4%B8%80%E8%B5%B7%E9%94%80%E6%AF%81%EF%BC%8C%E8%80%8C%E6%98%AF%E4%BC%9A%E8%A2%AB%E4%BF%9D%E7%95%99%E4%B8%8B%E6%9D%A5%E3%80%82%E6%80%8E%E4%B9%88%E5%81%9A%E5%88%B0%E7%9A%84%EF%BC%9F"><span class="toc-number">1.2.6.</span> <span class="toc-text">ViewModelStore ä¸ä¼šéš Activity ä¸€èµ·é”€æ¯ï¼Œè€Œæ˜¯ä¼šè¢«ä¿ç•™ä¸‹æ¥ã€‚æ€ä¹ˆåšåˆ°çš„ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#onRetainNonConfigurationInstance-%E5%92%8ConSaveInstanceState-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.2.7.</span> <span class="toc-text">onRetainNonConfigurationInstance() å’ŒonSaveInstanceState()çš„åŒºåˆ«</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#activity%E8%A2%AB%E9%94%80%E6%AF%81ViewModel%E6%80%8E%E4%B9%88%E7%9B%91%E5%90%AC%E7%9A%84%EF%BC%9F"><span class="toc-number">1.2.8.</span> <span class="toc-text">activityè¢«é”€æ¯ViewModelæ€ä¹ˆç›‘å¬çš„ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ViewModelStore%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BC%9A%E8%A2%AB%E9%94%80%E6%AF%81%EF%BC%9F"><span class="toc-number">1.2.9.</span> <span class="toc-text">ViewModelStoreä»€ä¹ˆæ—¶å€™ä¼šè¢«é”€æ¯ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AAActivity%E6%9C%89%E5%A4%9A%E4%B8%AAViewModel%EF%BC%8C%E6%80%8E%E4%B9%88%E5%8D%95%E7%8B%AC%E5%88%A0%E9%99%A4%E5%85%B6%E4%B8%AD%E4%B8%80%E4%B8%AA"><span class="toc-number">1.2.10.</span> <span class="toc-text">ä¸€ä¸ªActivityæœ‰å¤šä¸ªViewModelï¼Œæ€ä¹ˆå•ç‹¬åˆ é™¤å…¶ä¸­ä¸€ä¸ª</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ViewModel%E8%BF%9B%E8%A1%8C%E7%95%8C%E9%9D%A2%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%92"><span class="toc-number">1.2.11.</span> <span class="toc-text">ä½¿ç”¨ViewModelè¿›è¡Œç•Œé¢é—´çš„æ•°æ®ä¼ é€’</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E4%B8%80%E4%B8%AAActivity%E7%9A%84fragment-%E4%B9%8B%E9%97%B4%E5%85%B1%E4%BA%AB%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.11.1.</span> <span class="toc-text">åŒä¸€ä¸ªActivityçš„fragment ä¹‹é—´å…±äº«æ•°æ®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Activity%E4%B8%8E%E5%85%B6%E5%86%85%E9%83%A8%E7%9A%84Fragment%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.11.2.</span> <span class="toc-text">Activityä¸å…¶å†…éƒ¨çš„Fragmentè¿›è¡Œæ•°æ®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%90%8CActivity%E7%9A%84fragment-%E4%B9%8B%E9%97%B4%E5%85%B1%E4%BA%AB%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.11.3.</span> <span class="toc-text">ä¸åŒActivityçš„fragment ä¹‹é—´å…±äº«æ•°æ®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Activity%E4%B9%8B%E9%97%B4%E5%85%B1%E4%BA%AB%E6%95%B0%E6%8D%AE"><span class="toc-number">1.2.11.4.</span> <span class="toc-text">Activityä¹‹é—´å…±äº«æ•°æ®</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LiveData"><span class="toc-number">1.3.</span> <span class="toc-text">LiveData</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">ç®€ä»‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-1"><span class="toc-number">1.3.2.</span> <span class="toc-text">ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-1"><span class="toc-number">1.3.3.</span> <span class="toc-text">æºç è§£æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E7%9B%91%E5%90%AC"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">æ³¨å†Œç›‘å¬</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E5%9B%9E%E8%B0%83"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">çŠ¶æ€å›è°ƒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">å‘é€æ¶ˆæ¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LiveData-%E6%95%B0%E6%8D%AE%E9%87%8D%E6%94%BE%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">LiveData æ•°æ®é‡æ”¾åŸå› åˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LiveData-%E6%95%B0%E6%8D%AE%E9%87%8D%E6%94%BE%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.3.5.</span> <span class="toc-text">LiveData æ•°æ®é‡æ”¾é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%BC%98%E5%8A%BF"><span class="toc-number">1.3.3.6.</span> <span class="toc-text">ä½¿ç”¨ä¼˜åŠ¿</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LiveData-%E5%AD%98%E5%9C%A8%E7%9A%84%E5%B1%80%E9%99%90"><span class="toc-number">1.3.3.7.</span> <span class="toc-text">LiveData å­˜åœ¨çš„å±€é™</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LiveDataBus"><span class="toc-number">1.3.3.8.</span> <span class="toc-text">LiveDataBus</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AppStartup"><span class="toc-number">1.4.</span> <span class="toc-text">AppStartup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E6%96%B9%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.4.1.</span> <span class="toc-text">ä¸‰æ–¹åº“åˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ContentProvider-%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">ContentProvider çš„å¯åŠ¨è¿‡ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%9C%E7%94%A8"><span class="toc-number">1.4.3.</span> <span class="toc-text">ä½œç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="toc-number">1.4.4.</span> <span class="toc-text">ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">1.4.5.</span> <span class="toc-text">åŸç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Room"><span class="toc-number">1.5.</span> <span class="toc-text">Room</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-3"><span class="toc-number">1.5.1.</span> <span class="toc-text">ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8A%BF"><span class="toc-number">1.5.2.</span> <span class="toc-text">ä¼˜åŠ¿</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/23/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" title="æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ–</a><time datetime="2024-04-23T14:33:30.774Z" title="å‘è¡¨äº 2024-04-23 22:33:30">2024-04-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/23/%E7%BD%91%E7%BB%9C%E9%9D%A2%E8%AF%95%E9%A2%98/" title="ç½‘ç»œé¢è¯•é¢˜">ç½‘ç»œé¢è¯•é¢˜</a><time datetime="2024-04-23T14:33:30.773Z" title="å‘è¡¨äº 2024-04-23 22:33:30">2024-04-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/23/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title="è®¾è®¡æ¨¡å¼">è®¾è®¡æ¨¡å¼</a><time datetime="2024-04-23T14:33:30.771Z" title="å‘è¡¨äº 2024-04-23 22:33:30">2024-04-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/23/%E6%A3%80%E7%B4%A2/" title="æ£€ç´¢">æ£€ç´¢</a><time datetime="2024-04-23T14:33:30.768Z" title="å‘è¡¨äº 2024-04-23 22:33:30">2024-04-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/23/%E9%B8%BF%E8%92%99/" title="é¸¿è’™">é¸¿è’™</a><time datetime="2024-04-23T14:33:30.767Z" title="å‘è¡¨äº 2024-04-23 22:33:30">2024-04-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(()=>{
  const getGiscusTheme = theme => {
    return theme === 'dark' ? 'dark' : 'light'
  }

  const loadGiscus = () => {
    const config = Object.assign({
      src: 'https://giscus.app/client.js',
      'data-repo': 'zrmomo/comment',
      'data-repo-id': 'R_kgDOLFdqRA',
      'data-category-id': 'DIC_kwDOLFdqRM4CcdAM',
      'data-mapping': 'pathname',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true
    },null)

    const ele = document.createElement('script')
    for (let key in config) {
      ele.setAttribute(key, config[key])
    }
    document.getElementById('giscus-wrap').appendChild(ele)
  }

  const changeGiscusTheme = theme => {
    const sendMessage = message => {
      const iframe = document.querySelector('iframe.giscus-frame')
      if (!iframe) return
      iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app')
    }

    sendMessage({
      setConfig: {
        theme: getGiscusTheme(theme)
      }
    });
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment= loadGiscus
  }
})()</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>